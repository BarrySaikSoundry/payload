{"version":3,"sources":["../src/staticHandler.ts"],"sourcesContent":["import type { StaticHandler } from '@payloadcms/plugin-cloud-storage/types'\nimport type { Where } from 'payload'\nimport type { UTApi } from 'uploadthing/server'\n\nimport { getKeyFromFilename } from './utilities.js'\n\ntype Args = {\n  utApi: UTApi\n}\n\nexport const getHandler = ({ utApi }: Args): StaticHandler => {\n  return async (req, { doc, params: { collection, filename } }) => {\n    try {\n      const collectionConfig = req.payload.collections[collection]?.config\n      let retrievedDoc = doc\n\n      if (!retrievedDoc) {\n        const or: Where[] = [\n          {\n            filename: {\n              equals: filename,\n            },\n          },\n        ]\n\n        if (collectionConfig.upload.imageSizes) {\n          collectionConfig.upload.imageSizes.forEach(({ name }) => {\n            or.push({\n              [`sizes.${name}.filename`]: {\n                equals: filename,\n              },\n            })\n          })\n        }\n\n        const result = await req.payload.db.findOne({\n          collection,\n          req,\n          where: { or },\n        })\n\n        if (result) retrievedDoc = result\n      }\n\n      if (!retrievedDoc) {\n        return new Response(null, { status: 404, statusText: 'Not Found' })\n      }\n\n      const key = getKeyFromFilename(retrievedDoc, filename)\n      if (!key) {\n        return new Response(null, { status: 404, statusText: 'Not Found' })\n      }\n\n      const { url: signedURL } = await utApi.getSignedURL(key)\n\n      if (!signedURL) {\n        return new Response(null, { status: 404, statusText: 'Not Found' })\n      }\n\n      const response = await fetch(signedURL)\n\n      if (!response.ok) {\n        return new Response(null, { status: 404, statusText: 'Not Found' })\n      }\n\n      const blob = await response.blob()\n\n      return new Response(blob, {\n        headers: new Headers({\n          'Content-Length': String(blob.size),\n          'Content-Type': blob.type,\n        }),\n        status: 200,\n      })\n    } catch (err) {\n      req.payload.logger.error({ err, msg: 'Unexpected error in staticHandler' })\n      return new Response('Internal Server Error', { status: 500 })\n    }\n  }\n}\n"],"names":["getKeyFromFilename","getHandler","utApi","req","doc","params","collection","filename","collectionConfig","payload","collections","config","retrievedDoc","or","equals","upload","imageSizes","forEach","name","push","result","db","findOne","where","Response","status","statusText","key","url","signedURL","getSignedURL","response","fetch","ok","blob","headers","Headers","String","size","type","err","logger","error","msg"],"mappings":"AAIA,SAASA,kBAAkB,QAAQ,iBAAgB;AAMnD,OAAO,MAAMC,aAAa,CAAC,EAAEC,KAAK,EAAQ;IACxC,OAAO,OAAOC,KAAK,EAAEC,GAAG,EAAEC,QAAQ,EAAEC,UAAU,EAAEC,QAAQ,EAAE,EAAE;QAC1D,IAAI;YACF,MAAMC,mBAAmBL,IAAIM,OAAO,CAACC,WAAW,CAACJ,WAAW,EAAEK;YAC9D,IAAIC,eAAeR;YAEnB,IAAI,CAACQ,cAAc;gBACjB,MAAMC,KAAc;oBAClB;wBACEN,UAAU;4BACRO,QAAQP;wBACV;oBACF;iBACD;gBAED,IAAIC,iBAAiBO,MAAM,CAACC,UAAU,EAAE;oBACtCR,iBAAiBO,MAAM,CAACC,UAAU,CAACC,OAAO,CAAC,CAAC,EAAEC,IAAI,EAAE;wBAClDL,GAAGM,IAAI,CAAC;4BACN,CAAC,CAAC,MAAM,EAAED,KAAK,SAAS,CAAC,CAAC,EAAE;gCAC1BJ,QAAQP;4BACV;wBACF;oBACF;gBACF;gBAEA,MAAMa,SAAS,MAAMjB,IAAIM,OAAO,CAACY,EAAE,CAACC,OAAO,CAAC;oBAC1ChB;oBACAH;oBACAoB,OAAO;wBAAEV;oBAAG;gBACd;gBAEA,IAAIO,QAAQR,eAAeQ;YAC7B;YAEA,IAAI,CAACR,cAAc;gBACjB,OAAO,IAAIY,SAAS,MAAM;oBAAEC,QAAQ;oBAAKC,YAAY;gBAAY;YACnE;YAEA,MAAMC,MAAM3B,mBAAmBY,cAAcL;YAC7C,IAAI,CAACoB,KAAK;gBACR,OAAO,IAAIH,SAAS,MAAM;oBAAEC,QAAQ;oBAAKC,YAAY;gBAAY;YACnE;YAEA,MAAM,EAAEE,KAAKC,SAAS,EAAE,GAAG,MAAM3B,MAAM4B,YAAY,CAACH;YAEpD,IAAI,CAACE,WAAW;gBACd,OAAO,IAAIL,SAAS,MAAM;oBAAEC,QAAQ;oBAAKC,YAAY;gBAAY;YACnE;YAEA,MAAMK,WAAW,MAAMC,MAAMH;YAE7B,IAAI,CAACE,SAASE,EAAE,EAAE;gBAChB,OAAO,IAAIT,SAAS,MAAM;oBAAEC,QAAQ;oBAAKC,YAAY;gBAAY;YACnE;YAEA,MAAMQ,OAAO,MAAMH,SAASG,IAAI;YAEhC,OAAO,IAAIV,SAASU,MAAM;gBACxBC,SAAS,IAAIC,QAAQ;oBACnB,kBAAkBC,OAAOH,KAAKI,IAAI;oBAClC,gBAAgBJ,KAAKK,IAAI;gBAC3B;gBACAd,QAAQ;YACV;QACF,EAAE,OAAOe,KAAK;YACZrC,IAAIM,OAAO,CAACgC,MAAM,CAACC,KAAK,CAAC;gBAAEF;gBAAKG,KAAK;YAAoC;YACzE,OAAO,IAAInB,SAAS,yBAAyB;gBAAEC,QAAQ;YAAI;QAC7D;IACF;AACF,EAAC"}