{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import type {\n  Adapter,\n  PluginOptions as CloudStoragePluginOptions,\n  CollectionOptions,\n  GeneratedAdapter,\n} from '@payloadcms/plugin-cloud-storage/types'\nimport type { Config, Plugin } from 'payload'\n\nimport * as AWS from '@aws-sdk/client-s3'\nimport { cloudStoragePlugin } from '@payloadcms/plugin-cloud-storage'\n\nimport { getGenerateURL } from './generateURL.js'\nimport { getHandleDelete } from './handleDelete.js'\nimport { getHandleUpload } from './handleUpload.js'\nimport { getHandler } from './staticHandler.js'\n\nexport type S3StorageOptions = {\n  /**\n   * Access control list for uploaded files.\n   */\n\n  acl?: 'private' | 'public-read'\n  /**\n   * Bucket name to upload files to.\n   *\n   * Must follow [AWS S3 bucket naming conventions](https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucketnamingrules.html).\n   */\n\n  bucket: string\n\n  /**\n   * Collection options to apply the S3 adapter to.\n   */\n  collections: Record<string, Omit<CollectionOptions, 'adapter'> | true>\n  /**\n   * AWS S3 client configuration. Highly dependent on your AWS setup.\n   *\n   * [AWS.S3ClientConfig Docs](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/clients/client-s3/interfaces/s3clientconfig.html)\n   */\n  config: AWS.S3ClientConfig\n\n  /**\n   * Whether or not to disable local storage\n   *\n   * @default true\n   */\n  disableLocalStorage?: boolean\n\n  /**\n   * Whether or not to enable the plugin\n   *\n   * Default: true\n   */\n  enabled?: boolean\n}\n\ntype S3StoragePlugin = (storageS3Args: S3StorageOptions) => Plugin\n\nexport const s3Storage: S3StoragePlugin =\n  (s3StorageOptions: S3StorageOptions) =>\n  (incomingConfig: Config): Config => {\n    if (s3StorageOptions.enabled === false) {\n      return incomingConfig\n    }\n\n    const adapter = s3StorageInternal(s3StorageOptions)\n\n    // Add adapter to each collection option object\n    const collectionsWithAdapter: CloudStoragePluginOptions['collections'] = Object.entries(\n      s3StorageOptions.collections,\n    ).reduce(\n      (acc, [slug, collOptions]) => ({\n        ...acc,\n        [slug]: {\n          ...(collOptions === true ? {} : collOptions),\n          adapter,\n        },\n      }),\n      {} as Record<string, CollectionOptions>,\n    )\n\n    // Set disableLocalStorage: true for collections specified in the plugin options\n    const config = {\n      ...incomingConfig,\n      collections: (incomingConfig.collections || []).map((collection) => {\n        if (!collectionsWithAdapter[collection.slug]) {\n          return collection\n        }\n\n        return {\n          ...collection,\n          upload: {\n            ...(typeof collection.upload === 'object' ? collection.upload : {}),\n            disableLocalStorage: true,\n          },\n        }\n      }),\n    }\n\n    return cloudStoragePlugin({\n      collections: collectionsWithAdapter,\n    })(config)\n  }\n\nfunction s3StorageInternal({ acl, bucket, config = {} }: S3StorageOptions): Adapter {\n  return ({ collection, prefix }): GeneratedAdapter => {\n    let storageClient: AWS.S3 | null = null\n    const getStorageClient: () => AWS.S3 = () => {\n      if (storageClient) return storageClient\n      storageClient = new AWS.S3(config)\n      return storageClient\n    }\n\n    return {\n      name: 's3',\n      generateURL: getGenerateURL({ bucket, config }),\n      handleDelete: getHandleDelete({ bucket, getStorageClient }),\n      handleUpload: getHandleUpload({\n        acl,\n        bucket,\n        collection,\n        getStorageClient,\n        prefix,\n      }),\n      staticHandler: getHandler({ bucket, collection, getStorageClient }),\n    }\n  }\n}\n"],"names":["AWS","cloudStoragePlugin","getGenerateURL","getHandleDelete","getHandleUpload","getHandler","s3Storage","s3StorageOptions","incomingConfig","enabled","adapter","s3StorageInternal","collectionsWithAdapter","Object","entries","collections","reduce","acc","slug","collOptions","config","map","collection","upload","disableLocalStorage","acl","bucket","prefix","storageClient","getStorageClient","S3","name","generateURL","handleDelete","handleUpload","staticHandler"],"mappings":"AAQA,YAAYA,SAAS,qBAAoB;AACzC,SAASC,kBAAkB,QAAQ,mCAAkC;AAErE,SAASC,cAAc,QAAQ,mBAAkB;AACjD,SAASC,eAAe,QAAQ,oBAAmB;AACnD,SAASC,eAAe,QAAQ,oBAAmB;AACnD,SAASC,UAAU,QAAQ,qBAAoB;AA4C/C,OAAO,MAAMC,YACX,CAACC,mBACD,CAACC;QACC,IAAID,iBAAiBE,OAAO,KAAK,OAAO;YACtC,OAAOD;QACT;QAEA,MAAME,UAAUC,kBAAkBJ;QAElC,+CAA+C;QAC/C,MAAMK,yBAAmEC,OAAOC,OAAO,CACrFP,iBAAiBQ,WAAW,EAC5BC,MAAM,CACN,CAACC,KAAK,CAACC,MAAMC,YAAY,GAAM,CAAA;gBAC7B,GAAGF,GAAG;gBACN,CAACC,KAAK,EAAE;oBACN,GAAIC,gBAAgB,OAAO,CAAC,IAAIA,WAAW;oBAC3CT;gBACF;YACF,CAAA,GACA,CAAC;QAGH,gFAAgF;QAChF,MAAMU,SAAS;YACb,GAAGZ,cAAc;YACjBO,aAAa,AAACP,CAAAA,eAAeO,WAAW,IAAI,EAAE,AAAD,EAAGM,GAAG,CAAC,CAACC;gBACnD,IAAI,CAACV,sBAAsB,CAACU,WAAWJ,IAAI,CAAC,EAAE;oBAC5C,OAAOI;gBACT;gBAEA,OAAO;oBACL,GAAGA,UAAU;oBACbC,QAAQ;wBACN,GAAI,OAAOD,WAAWC,MAAM,KAAK,WAAWD,WAAWC,MAAM,GAAG,CAAC,CAAC;wBAClEC,qBAAqB;oBACvB;gBACF;YACF;QACF;QAEA,OAAOvB,mBAAmB;YACxBc,aAAaH;QACf,GAAGQ;IACL,EAAC;AAEH,SAAST,kBAAkB,EAAEc,GAAG,EAAEC,MAAM,EAAEN,SAAS,CAAC,CAAC,EAAoB;IACvE,OAAO,CAAC,EAAEE,UAAU,EAAEK,MAAM,EAAE;QAC5B,IAAIC,gBAA+B;QACnC,MAAMC,mBAAiC;YACrC,IAAID,eAAe,OAAOA;YAC1BA,gBAAgB,IAAI5B,IAAI8B,EAAE,CAACV;YAC3B,OAAOQ;QACT;QAEA,OAAO;YACLG,MAAM;YACNC,aAAa9B,eAAe;gBAAEwB;gBAAQN;YAAO;YAC7Ca,cAAc9B,gBAAgB;gBAAEuB;gBAAQG;YAAiB;YACzDK,cAAc9B,gBAAgB;gBAC5BqB;gBACAC;gBACAJ;gBACAO;gBACAF;YACF;YACAQ,eAAe9B,WAAW;gBAAEqB;gBAAQJ;gBAAYO;YAAiB;QACnE;IACF;AACF"}