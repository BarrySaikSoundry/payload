{"version":3,"sources":["../../src/webhooks/handleDeleted.ts"],"sourcesContent":["import type { SanitizedStripePluginConfig, StripeWebhookHandler } from '../types.js'\n\ntype HandleDeleted = (\n  args: {\n    resourceType: string\n    syncConfig: SanitizedStripePluginConfig['sync'][0]\n  } & Parameters<StripeWebhookHandler>[0],\n) => void\n\nexport const handleDeleted: HandleDeleted = async (args) => {\n  const { event, payload, pluginConfig, resourceType, syncConfig } = args\n\n  const { logs } = pluginConfig || {}\n\n  const collectionSlug = syncConfig?.collection\n\n  const {\n    id: stripeID,\n    object: eventObject, // use this to determine if this is a nested field\n  }: any = event?.data?.object || {}\n\n  // if the event object and resource type don't match, this deletion was not top-level\n  const isNestedDelete = eventObject !== resourceType\n\n  if (isNestedDelete) {\n    if (logs)\n      payload.logger.info(\n        `- This deletion occurred on a nested field of ${resourceType}. Nested fields are not yet supported.`,\n      )\n  }\n\n  if (!isNestedDelete) {\n    if (logs)\n      payload.logger.info(\n        `- A '${resourceType}' resource was deleted in Stripe, now deleting '${collectionSlug}' document in Payload with Stripe ID: '${stripeID}'...`,\n      )\n\n    try {\n      const payloadQuery = await payload.find({\n        collection: collectionSlug,\n        where: {\n          stripeID: {\n            equals: stripeID,\n          },\n        },\n      })\n\n      const foundDoc = payloadQuery.docs[0] as any\n\n      if (!foundDoc) {\n        if (logs)\n          payload.logger.info(\n            `- Nothing to delete, no existing document found with Stripe ID: '${stripeID}'.`,\n          )\n      }\n\n      if (foundDoc) {\n        if (logs) payload.logger.info(`- Deleting Payload document with ID: '${foundDoc.id}'...`)\n\n        try {\n          // eslint-disable-next-line @typescript-eslint/no-floating-promises\n          payload.delete({\n            id: foundDoc.id,\n            collection: collectionSlug,\n          })\n\n          // NOTE: the `afterDelete` hook will trigger, which will attempt to delete the document from Stripe and safely error out\n          // There is no known way of preventing this from happening. In other hooks we use the `skipSync` field, but here the document is already deleted.\n          if (logs)\n            payload.logger.info(\n              `- âœ… Successfully deleted Payload document with ID: '${foundDoc.id}'.`,\n            )\n        } catch (error: unknown) {\n          const msg = error instanceof Error ? error.message : error\n          if (logs) payload.logger.error(`Error deleting document: ${msg}`)\n        }\n      }\n    } catch (error: unknown) {\n      const msg = error instanceof Error ? error.message : error\n      if (logs) payload.logger.error(`Error deleting document: ${msg}`)\n    }\n  }\n}\n"],"names":["handleDeleted","args","event","payload","pluginConfig","resourceType","syncConfig","logs","collectionSlug","collection","id","stripeID","object","eventObject","data","isNestedDelete","logger","info","payloadQuery","find","where","equals","foundDoc","docs","delete","error","msg","Error","message"],"mappings":"AASA,OAAO,MAAMA,gBAA+B,OAAOC;IACjD,MAAM,EAAEC,KAAK,EAAEC,OAAO,EAAEC,YAAY,EAAEC,YAAY,EAAEC,UAAU,EAAE,GAAGL;IAEnE,MAAM,EAAEM,IAAI,EAAE,GAAGH,gBAAgB,CAAC;IAElC,MAAMI,iBAAiBF,YAAYG;IAEnC,MAAM,EACJC,IAAIC,QAAQ,EACZC,QAAQC,WAAW,EACpB,GAAQX,OAAOY,MAAMF,UAAU,CAAC;IAEjC,qFAAqF;IACrF,MAAMG,iBAAiBF,gBAAgBR;IAEvC,IAAIU,gBAAgB;QAClB,IAAIR,MACFJ,QAAQa,MAAM,CAACC,IAAI,CACjB,CAAC,8CAA8C,EAAEZ,aAAa,sCAAsC,CAAC;IAE3G;IAEA,IAAI,CAACU,gBAAgB;QACnB,IAAIR,MACFJ,QAAQa,MAAM,CAACC,IAAI,CACjB,CAAC,KAAK,EAAEZ,aAAa,gDAAgD,EAAEG,eAAe,uCAAuC,EAAEG,SAAS,IAAI,CAAC;QAGjJ,IAAI;YACF,MAAMO,eAAe,MAAMf,QAAQgB,IAAI,CAAC;gBACtCV,YAAYD;gBACZY,OAAO;oBACLT,UAAU;wBACRU,QAAQV;oBACV;gBACF;YACF;YAEA,MAAMW,WAAWJ,aAAaK,IAAI,CAAC,EAAE;YAErC,IAAI,CAACD,UAAU;gBACb,IAAIf,MACFJ,QAAQa,MAAM,CAACC,IAAI,CACjB,CAAC,iEAAiE,EAAEN,SAAS,EAAE,CAAC;YAEtF;YAEA,IAAIW,UAAU;gBACZ,IAAIf,MAAMJ,QAAQa,MAAM,CAACC,IAAI,CAAC,CAAC,sCAAsC,EAAEK,SAASZ,EAAE,CAAC,IAAI,CAAC;gBAExF,IAAI;oBACF,mEAAmE;oBACnEP,QAAQqB,MAAM,CAAC;wBACbd,IAAIY,SAASZ,EAAE;wBACfD,YAAYD;oBACd;oBAEA,wHAAwH;oBACxH,iJAAiJ;oBACjJ,IAAID,MACFJ,QAAQa,MAAM,CAACC,IAAI,CACjB,CAAC,oDAAoD,EAAEK,SAASZ,EAAE,CAAC,EAAE,CAAC;gBAE5E,EAAE,OAAOe,OAAgB;oBACvB,MAAMC,MAAMD,iBAAiBE,QAAQF,MAAMG,OAAO,GAAGH;oBACrD,IAAIlB,MAAMJ,QAAQa,MAAM,CAACS,KAAK,CAAC,CAAC,yBAAyB,EAAEC,IAAI,CAAC;gBAClE;YACF;QACF,EAAE,OAAOD,OAAgB;YACvB,MAAMC,MAAMD,iBAAiBE,QAAQF,MAAMG,OAAO,GAAGH;YACrD,IAAIlB,MAAMJ,QAAQa,MAAM,CAACS,KAAK,CAAC,CAAC,yBAAyB,EAAEC,IAAI,CAAC;QAClE;IACF;AACF,EAAC"}