{"version":3,"sources":["../../src/hooks/beforeChange.ts"],"sourcesContent":["import type { CollectionConfig, Config, FieldHook, RelationshipField, UploadField } from 'payload'\n\nimport mongoose from 'mongoose'\nimport { fieldAffectsData } from 'payload/shared'\n\nconst convertValue = ({\n  relatedCollection,\n  value,\n}: {\n  relatedCollection: CollectionConfig\n  value: number | string\n}): mongoose.Types.ObjectId | number | string => {\n  const customIDField = relatedCollection.fields.find(\n    (field) => fieldAffectsData(field) && field.name === 'id',\n  )\n\n  if (!customIDField) return new mongoose.Types.ObjectId(value)\n\n  return value\n}\n\ninterface RelationObject {\n  relationTo: string\n  value: number | string\n}\n\nfunction isValidRelationObject(value: unknown): value is RelationObject {\n  return typeof value === 'object' && value !== null && 'relationTo' in value && 'value' in value\n}\n\nexport const getBeforeChangeHook =\n  ({ config, field }: { config: Config; field: RelationshipField | UploadField }): FieldHook =>\n  ({ value }) => {\n    let relatedCollection: CollectionConfig | undefined\n\n    const hasManyRelations = typeof field.relationTo !== 'string'\n\n    if (!hasManyRelations) {\n      relatedCollection = config.collections?.find(({ slug }) => slug === field.relationTo)\n    }\n\n    if (Array.isArray(value)) {\n      return value.map((val) => {\n        // Handle has many\n        if (relatedCollection && val && (typeof val === 'string' || typeof val === 'number')) {\n          return convertValue({\n            relatedCollection,\n            value: val,\n          })\n        }\n\n        // Handle has many - polymorphic\n        if (isValidRelationObject(val)) {\n          const relatedCollectionForSingleValue = config.collections?.find(\n            ({ slug }) => slug === val.relationTo,\n          )\n\n          if (relatedCollectionForSingleValue) {\n            return {\n              relationTo: val.relationTo,\n              value: convertValue({\n                relatedCollection: relatedCollectionForSingleValue,\n                value: val.value,\n              }),\n            }\n          }\n        }\n\n        return val\n      })\n    }\n\n    // Handle has one - polymorphic\n    if (isValidRelationObject(value)) {\n      relatedCollection = config.collections?.find(({ slug }) => slug === value.relationTo)\n\n      if (relatedCollection) {\n        return {\n          relationTo: value.relationTo,\n          value: convertValue({ relatedCollection, value: value.value }),\n        }\n      }\n    }\n\n    // Handle has one\n    if (relatedCollection && value && (typeof value === 'string' || typeof value === 'number')) {\n      return convertValue({\n        relatedCollection,\n        value,\n      })\n    }\n\n    return value\n  }\n"],"names":["mongoose","fieldAffectsData","convertValue","relatedCollection","value","customIDField","fields","find","field","name","Types","ObjectId","isValidRelationObject","getBeforeChangeHook","config","hasManyRelations","relationTo","collections","slug","Array","isArray","map","val","relatedCollectionForSingleValue"],"mappings":"AAEA,OAAOA,cAAc,WAAU;AAC/B,SAASC,gBAAgB,QAAQ,iBAAgB;AAEjD,MAAMC,eAAe,CAAC,EACpBC,iBAAiB,EACjBC,KAAK,EAIN;IACC,MAAMC,gBAAgBF,kBAAkBG,MAAM,CAACC,IAAI,CACjD,CAACC,QAAUP,iBAAiBO,UAAUA,MAAMC,IAAI,KAAK;IAGvD,IAAI,CAACJ,eAAe,OAAO,IAAIL,SAASU,KAAK,CAACC,QAAQ,CAACP;IAEvD,OAAOA;AACT;AAOA,SAASQ,sBAAsBR,KAAc;IAC3C,OAAO,OAAOA,UAAU,YAAYA,UAAU,QAAQ,gBAAgBA,SAAS,WAAWA;AAC5F;AAEA,OAAO,MAAMS,sBACX,CAAC,EAAEC,MAAM,EAAEN,KAAK,EAA8D,GAC9E,CAAC,EAAEJ,KAAK,EAAE;QACR,IAAID;QAEJ,MAAMY,mBAAmB,OAAOP,MAAMQ,UAAU,KAAK;QAErD,IAAI,CAACD,kBAAkB;YACrBZ,oBAAoBW,OAAOG,WAAW,EAAEV,KAAK,CAAC,EAAEW,IAAI,EAAE,GAAKA,SAASV,MAAMQ,UAAU;QACtF;QAEA,IAAIG,MAAMC,OAAO,CAAChB,QAAQ;YACxB,OAAOA,MAAMiB,GAAG,CAAC,CAACC;gBAChB,kBAAkB;gBAClB,IAAInB,qBAAqBmB,OAAQ,CAAA,OAAOA,QAAQ,YAAY,OAAOA,QAAQ,QAAO,GAAI;oBACpF,OAAOpB,aAAa;wBAClBC;wBACAC,OAAOkB;oBACT;gBACF;gBAEA,gCAAgC;gBAChC,IAAIV,sBAAsBU,MAAM;oBAC9B,MAAMC,kCAAkCT,OAAOG,WAAW,EAAEV,KAC1D,CAAC,EAAEW,IAAI,EAAE,GAAKA,SAASI,IAAIN,UAAU;oBAGvC,IAAIO,iCAAiC;wBACnC,OAAO;4BACLP,YAAYM,IAAIN,UAAU;4BAC1BZ,OAAOF,aAAa;gCAClBC,mBAAmBoB;gCACnBnB,OAAOkB,IAAIlB,KAAK;4BAClB;wBACF;oBACF;gBACF;gBAEA,OAAOkB;YACT;QACF;QAEA,+BAA+B;QAC/B,IAAIV,sBAAsBR,QAAQ;YAChCD,oBAAoBW,OAAOG,WAAW,EAAEV,KAAK,CAAC,EAAEW,IAAI,EAAE,GAAKA,SAASd,MAAMY,UAAU;YAEpF,IAAIb,mBAAmB;gBACrB,OAAO;oBACLa,YAAYZ,MAAMY,UAAU;oBAC5BZ,OAAOF,aAAa;wBAAEC;wBAAmBC,OAAOA,MAAMA,KAAK;oBAAC;gBAC9D;YACF;QACF;QAEA,iBAAiB;QACjB,IAAID,qBAAqBC,SAAU,CAAA,OAAOA,UAAU,YAAY,OAAOA,UAAU,QAAO,GAAI;YAC1F,OAAOF,aAAa;gBAClBC;gBACAC;YACF;QACF;QAEA,OAAOA;IACT,EAAC"}