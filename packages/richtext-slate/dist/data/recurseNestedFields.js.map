{"version":3,"sources":["../../src/data/recurseNestedFields.ts"],"sourcesContent":["import type { Field, PayloadRequest } from 'payload'\n\nimport { fieldAffectsData, fieldHasSubFields, fieldIsArrayType, tabHasName } from 'payload/shared'\n\nimport { populate } from './populate.js'\nimport { recurseRichText } from './richTextRelationshipPromise.js'\n\ntype NestedRichTextFieldsArgs = {\n  currentDepth?: number\n  data: unknown\n  depth: number\n  draft: boolean\n  fields: Field[]\n  overrideAccess: boolean\n  populationPromises: Promise<void>[]\n  req: PayloadRequest\n  showHiddenFields: boolean\n}\n\nexport const recurseNestedFields = ({\n  currentDepth = 0,\n  data,\n  depth,\n  draft,\n  fields,\n  overrideAccess = false,\n  populationPromises,\n  req,\n  showHiddenFields,\n}: NestedRichTextFieldsArgs): void => {\n  fields.forEach((field) => {\n    if (field.type === 'relationship' || field.type === 'upload') {\n      if (field.type === 'relationship') {\n        if (field.hasMany && Array.isArray(data[field.name])) {\n          if (Array.isArray(field.relationTo)) {\n            data[field.name].forEach(({ relationTo, value }, i) => {\n              const collection = req.payload.collections[relationTo]\n              if (collection) {\n                populationPromises.push(\n                  populate({\n                    id: value,\n                    collection,\n                    currentDepth,\n                    data: data[field.name],\n                    depth,\n                    draft,\n                    field,\n                    key: i,\n                    overrideAccess,\n                    req,\n                    showHiddenFields,\n                  }),\n                )\n              }\n            })\n          } else {\n            data[field.name].forEach((id, i) => {\n              const collection = req.payload.collections[field.relationTo as string]\n              if (collection) {\n                populationPromises.push(\n                  populate({\n                    id,\n                    collection,\n                    currentDepth,\n                    data: data[field.name],\n                    depth,\n                    draft,\n                    field,\n                    key: i,\n                    overrideAccess,\n                    req,\n                    showHiddenFields,\n                  }),\n                )\n              }\n            })\n          }\n        } else if (\n          Array.isArray(field.relationTo) &&\n          data[field.name]?.value &&\n          data[field.name]?.relationTo\n        ) {\n          if (!('hasMany' in field) || !field.hasMany) {\n            const collection = req.payload.collections[data[field.name].relationTo]\n            populationPromises.push(\n              populate({\n                id: data[field.name].value,\n                collection,\n                currentDepth,\n                data: data[field.name],\n                depth,\n                draft,\n                field,\n                key: 'value',\n                overrideAccess,\n                req,\n                showHiddenFields,\n              }),\n            )\n          }\n        }\n      }\n      if (typeof data[field.name] !== 'undefined' && typeof field.relationTo === 'string') {\n        const collection = req.payload.collections[field.relationTo]\n        populationPromises.push(\n          populate({\n            id: data[field.name],\n            collection,\n            currentDepth,\n            data,\n            depth,\n            draft,\n            field,\n            key: field.name,\n            overrideAccess,\n            req,\n            showHiddenFields,\n          }),\n        )\n      }\n    } else if (fieldHasSubFields(field) && !fieldIsArrayType(field)) {\n      if (fieldAffectsData(field) && typeof data[field.name] === 'object') {\n        recurseNestedFields({\n          currentDepth,\n          data: data[field.name],\n          depth,\n          draft,\n          fields: field.fields,\n          overrideAccess,\n          populationPromises,\n          req,\n          showHiddenFields,\n        })\n      } else {\n        recurseNestedFields({\n          currentDepth,\n          data,\n          depth,\n          draft,\n          fields: field.fields,\n          overrideAccess,\n          populationPromises,\n          req,\n          showHiddenFields,\n        })\n      }\n    } else if (field.type === 'tabs') {\n      field.tabs.forEach((tab) => {\n        recurseNestedFields({\n          currentDepth,\n          data: tabHasName(tab) ? data[tab.name] : data,\n          depth,\n          draft,\n          fields: tab.fields,\n          overrideAccess,\n          populationPromises,\n          req,\n          showHiddenFields,\n        })\n      })\n    } else if (Array.isArray(data[field.name])) {\n      if (field.type === 'blocks') {\n        data[field.name].forEach((row, i) => {\n          const block = field.blocks.find(({ slug }) => slug === row?.blockType)\n          if (block) {\n            recurseNestedFields({\n              currentDepth,\n              data: data[field.name][i],\n              depth,\n              draft,\n              fields: block.fields,\n              overrideAccess,\n              populationPromises,\n              req,\n              showHiddenFields,\n            })\n          }\n        })\n      }\n\n      if (field.type === 'array') {\n        data[field.name].forEach((_, i) => {\n          recurseNestedFields({\n            currentDepth,\n            data: data[field.name][i],\n            depth,\n            draft,\n            fields: field.fields,\n            overrideAccess,\n            populationPromises,\n            req,\n            showHiddenFields,\n          })\n        })\n      }\n    }\n\n    if (field.type === 'richText' && Array.isArray(data[field.name])) {\n      data[field.name].forEach((node) => {\n        if (Array.isArray(node.children)) {\n          recurseRichText({\n            children: node.children,\n            currentDepth,\n            depth,\n            draft,\n            field,\n            overrideAccess,\n            populationPromises,\n            req,\n            showHiddenFields,\n          })\n        }\n      })\n    }\n  })\n}\n"],"names":["fieldAffectsData","fieldHasSubFields","fieldIsArrayType","tabHasName","populate","recurseRichText","recurseNestedFields","currentDepth","data","depth","draft","fields","overrideAccess","populationPromises","req","showHiddenFields","forEach","field","type","hasMany","Array","isArray","name","relationTo","value","i","collection","payload","collections","push","id","key","tabs","tab","row","block","blocks","find","slug","blockType","_","node","children"],"mappings":"AAEA,SAASA,gBAAgB,EAAEC,iBAAiB,EAAEC,gBAAgB,EAAEC,UAAU,QAAQ,iBAAgB;AAElG,SAASC,QAAQ,QAAQ,gBAAe;AACxC,SAASC,eAAe,QAAQ,mCAAkC;AAclE,OAAO,MAAMC,sBAAsB,CAAC,EAClCC,eAAe,CAAC,EAChBC,IAAI,EACJC,KAAK,EACLC,KAAK,EACLC,MAAM,EACNC,iBAAiB,KAAK,EACtBC,kBAAkB,EAClBC,GAAG,EACHC,gBAAgB,EACS;IACzBJ,OAAOK,OAAO,CAAC,CAACC;QACd,IAAIA,MAAMC,IAAI,KAAK,kBAAkBD,MAAMC,IAAI,KAAK,UAAU;YAC5D,IAAID,MAAMC,IAAI,KAAK,gBAAgB;gBACjC,IAAID,MAAME,OAAO,IAAIC,MAAMC,OAAO,CAACb,IAAI,CAACS,MAAMK,IAAI,CAAC,GAAG;oBACpD,IAAIF,MAAMC,OAAO,CAACJ,MAAMM,UAAU,GAAG;wBACnCf,IAAI,CAACS,MAAMK,IAAI,CAAC,CAACN,OAAO,CAAC,CAAC,EAAEO,UAAU,EAAEC,KAAK,EAAE,EAAEC;4BAC/C,MAAMC,aAAaZ,IAAIa,OAAO,CAACC,WAAW,CAACL,WAAW;4BACtD,IAAIG,YAAY;gCACdb,mBAAmBgB,IAAI,CACrBzB,SAAS;oCACP0B,IAAIN;oCACJE;oCACAnB;oCACAC,MAAMA,IAAI,CAACS,MAAMK,IAAI,CAAC;oCACtBb;oCACAC;oCACAO;oCACAc,KAAKN;oCACLb;oCACAE;oCACAC;gCACF;4BAEJ;wBACF;oBACF,OAAO;wBACLP,IAAI,CAACS,MAAMK,IAAI,CAAC,CAACN,OAAO,CAAC,CAACc,IAAIL;4BAC5B,MAAMC,aAAaZ,IAAIa,OAAO,CAACC,WAAW,CAACX,MAAMM,UAAU,CAAW;4BACtE,IAAIG,YAAY;gCACdb,mBAAmBgB,IAAI,CACrBzB,SAAS;oCACP0B;oCACAJ;oCACAnB;oCACAC,MAAMA,IAAI,CAACS,MAAMK,IAAI,CAAC;oCACtBb;oCACAC;oCACAO;oCACAc,KAAKN;oCACLb;oCACAE;oCACAC;gCACF;4BAEJ;wBACF;oBACF;gBACF,OAAO,IACLK,MAAMC,OAAO,CAACJ,MAAMM,UAAU,KAC9Bf,IAAI,CAACS,MAAMK,IAAI,CAAC,EAAEE,SAClBhB,IAAI,CAACS,MAAMK,IAAI,CAAC,EAAEC,YAClB;oBACA,IAAI,CAAE,CAAA,aAAaN,KAAI,KAAM,CAACA,MAAME,OAAO,EAAE;wBAC3C,MAAMO,aAAaZ,IAAIa,OAAO,CAACC,WAAW,CAACpB,IAAI,CAACS,MAAMK,IAAI,CAAC,CAACC,UAAU,CAAC;wBACvEV,mBAAmBgB,IAAI,CACrBzB,SAAS;4BACP0B,IAAItB,IAAI,CAACS,MAAMK,IAAI,CAAC,CAACE,KAAK;4BAC1BE;4BACAnB;4BACAC,MAAMA,IAAI,CAACS,MAAMK,IAAI,CAAC;4BACtBb;4BACAC;4BACAO;4BACAc,KAAK;4BACLnB;4BACAE;4BACAC;wBACF;oBAEJ;gBACF;YACF;YACA,IAAI,OAAOP,IAAI,CAACS,MAAMK,IAAI,CAAC,KAAK,eAAe,OAAOL,MAAMM,UAAU,KAAK,UAAU;gBACnF,MAAMG,aAAaZ,IAAIa,OAAO,CAACC,WAAW,CAACX,MAAMM,UAAU,CAAC;gBAC5DV,mBAAmBgB,IAAI,CACrBzB,SAAS;oBACP0B,IAAItB,IAAI,CAACS,MAAMK,IAAI,CAAC;oBACpBI;oBACAnB;oBACAC;oBACAC;oBACAC;oBACAO;oBACAc,KAAKd,MAAMK,IAAI;oBACfV;oBACAE;oBACAC;gBACF;YAEJ;QACF,OAAO,IAAId,kBAAkBgB,UAAU,CAACf,iBAAiBe,QAAQ;YAC/D,IAAIjB,iBAAiBiB,UAAU,OAAOT,IAAI,CAACS,MAAMK,IAAI,CAAC,KAAK,UAAU;gBACnEhB,oBAAoB;oBAClBC;oBACAC,MAAMA,IAAI,CAACS,MAAMK,IAAI,CAAC;oBACtBb;oBACAC;oBACAC,QAAQM,MAAMN,MAAM;oBACpBC;oBACAC;oBACAC;oBACAC;gBACF;YACF,OAAO;gBACLT,oBAAoB;oBAClBC;oBACAC;oBACAC;oBACAC;oBACAC,QAAQM,MAAMN,MAAM;oBACpBC;oBACAC;oBACAC;oBACAC;gBACF;YACF;QACF,OAAO,IAAIE,MAAMC,IAAI,KAAK,QAAQ;YAChCD,MAAMe,IAAI,CAAChB,OAAO,CAAC,CAACiB;gBAClB3B,oBAAoB;oBAClBC;oBACAC,MAAML,WAAW8B,OAAOzB,IAAI,CAACyB,IAAIX,IAAI,CAAC,GAAGd;oBACzCC;oBACAC;oBACAC,QAAQsB,IAAItB,MAAM;oBAClBC;oBACAC;oBACAC;oBACAC;gBACF;YACF;QACF,OAAO,IAAIK,MAAMC,OAAO,CAACb,IAAI,CAACS,MAAMK,IAAI,CAAC,GAAG;YAC1C,IAAIL,MAAMC,IAAI,KAAK,UAAU;gBAC3BV,IAAI,CAACS,MAAMK,IAAI,CAAC,CAACN,OAAO,CAAC,CAACkB,KAAKT;oBAC7B,MAAMU,QAAQlB,MAAMmB,MAAM,CAACC,IAAI,CAAC,CAAC,EAAEC,IAAI,EAAE,GAAKA,SAASJ,KAAKK;oBAC5D,IAAIJ,OAAO;wBACT7B,oBAAoB;4BAClBC;4BACAC,MAAMA,IAAI,CAACS,MAAMK,IAAI,CAAC,CAACG,EAAE;4BACzBhB;4BACAC;4BACAC,QAAQwB,MAAMxB,MAAM;4BACpBC;4BACAC;4BACAC;4BACAC;wBACF;oBACF;gBACF;YACF;YAEA,IAAIE,MAAMC,IAAI,KAAK,SAAS;gBAC1BV,IAAI,CAACS,MAAMK,IAAI,CAAC,CAACN,OAAO,CAAC,CAACwB,GAAGf;oBAC3BnB,oBAAoB;wBAClBC;wBACAC,MAAMA,IAAI,CAACS,MAAMK,IAAI,CAAC,CAACG,EAAE;wBACzBhB;wBACAC;wBACAC,QAAQM,MAAMN,MAAM;wBACpBC;wBACAC;wBACAC;wBACAC;oBACF;gBACF;YACF;QACF;QAEA,IAAIE,MAAMC,IAAI,KAAK,cAAcE,MAAMC,OAAO,CAACb,IAAI,CAACS,MAAMK,IAAI,CAAC,GAAG;YAChEd,IAAI,CAACS,MAAMK,IAAI,CAAC,CAACN,OAAO,CAAC,CAACyB;gBACxB,IAAIrB,MAAMC,OAAO,CAACoB,KAAKC,QAAQ,GAAG;oBAChCrC,gBAAgB;wBACdqC,UAAUD,KAAKC,QAAQ;wBACvBnC;wBACAE;wBACAC;wBACAO;wBACAL;wBACAC;wBACAC;wBACAC;oBACF;gBACF;YACF;QACF;IACF;AACF,EAAC"}