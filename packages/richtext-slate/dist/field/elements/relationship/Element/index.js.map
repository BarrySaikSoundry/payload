{"version":3,"sources":["../../../../../src/field/elements/relationship/Element/index.tsx"],"sourcesContent":["'use client'\n\nimport type { FormFieldBase } from '@payloadcms/ui'\n\nimport { getTranslation } from '@payloadcms/translations'\nimport {\n  Button,\n  useConfig,\n  useDocumentDrawer,\n  useListDrawer,\n  usePayloadAPI,\n  useTranslation,\n} from '@payloadcms/ui'\nimport React, { useCallback, useReducer, useState } from 'react'\nimport { Transforms } from 'slate'\nimport { ReactEditor, useFocused, useSelected, useSlateStatic } from 'slate-react'\n\nimport type { RelationshipElementType } from '../types.js'\n\nimport { useElement } from '../../../providers/ElementProvider.js'\nimport { EnabledRelationshipsCondition } from '../../EnabledRelationshipsCondition.js'\nimport './index.scss'\n\nconst baseClass = 'rich-text-relationship'\n\nconst initialParams = {\n  depth: 0,\n}\n\ntype Props = {\n  name: string\n  richTextComponentMap: Map<string, React.ReactNode>\n} & FormFieldBase\n\nconst RelationshipElement: React.FC<Props> = () => {\n  const {\n    attributes,\n    children,\n    element,\n    element: { relationTo, value },\n    fieldProps,\n  } = useElement<RelationshipElementType>()\n\n  const {\n    collections,\n    routes: { api },\n    serverURL,\n  } = useConfig()\n  const [enabledCollectionSlugs] = useState(() =>\n    collections\n      .filter(({ admin: { enableRichTextRelationship } }) => enableRichTextRelationship)\n      .map(({ slug }) => slug),\n  )\n  const [relatedCollection, setRelatedCollection] = useState(() =>\n    collections.find((coll) => coll.slug === relationTo),\n  )\n\n  const selected = useSelected()\n  const focused = useFocused()\n  const { i18n, t } = useTranslation()\n  const editor = useSlateStatic()\n  const [cacheBust, dispatchCacheBust] = useReducer((state) => state + 1, 0)\n  const [{ data }, { setParams }] = usePayloadAPI(\n    `${serverURL}${api}/${relatedCollection.slug}/${value?.id}`,\n    { initialParams },\n  )\n\n  const [DocumentDrawer, DocumentDrawerToggler, { closeDrawer }] = useDocumentDrawer({\n    id: value?.id,\n    collectionSlug: relatedCollection.slug,\n  })\n\n  const [ListDrawer, ListDrawerToggler, { closeDrawer: closeListDrawer }] = useListDrawer({\n    collectionSlugs: enabledCollectionSlugs,\n    selectedCollection: relatedCollection.slug,\n  })\n\n  const removeRelationship = useCallback(() => {\n    const elementPath = ReactEditor.findPath(editor, element)\n\n    Transforms.removeNodes(editor, { at: elementPath })\n  }, [editor, element])\n\n  const updateRelationship = React.useCallback(\n    ({ doc }) => {\n      const elementPath = ReactEditor.findPath(editor, element)\n\n      Transforms.setNodes(\n        editor,\n        {\n          type: 'relationship',\n          children: [{ text: ' ' }],\n          relationTo: relatedCollection.slug,\n          value: { id: doc.id },\n        },\n        { at: elementPath },\n      )\n\n      setParams({\n        ...initialParams,\n        cacheBust, // do this to get the usePayloadAPI to re-fetch the data even though the URL string hasn't changed\n      })\n\n      closeDrawer()\n      dispatchCacheBust()\n    },\n    [editor, element, relatedCollection, cacheBust, setParams, closeDrawer],\n  )\n\n  const swapRelationship = React.useCallback(\n    ({ collectionSlug, docID }) => {\n      const elementPath = ReactEditor.findPath(editor, element)\n\n      Transforms.setNodes(\n        editor,\n        {\n          type: 'relationship',\n          children: [{ text: ' ' }],\n          relationTo: collectionSlug,\n          value: { id: docID },\n        },\n        { at: elementPath },\n      )\n\n      setRelatedCollection(collections.find((coll) => coll.slug === collectionSlug))\n\n      setParams({\n        ...initialParams,\n        cacheBust, // do this to get the usePayloadAPI to re-fetch the data even though the URL string hasn't changed\n      })\n\n      closeListDrawer()\n      dispatchCacheBust()\n    },\n    [closeListDrawer, editor, element, cacheBust, setParams, collections],\n  )\n\n  return (\n    <div\n      className={[baseClass, selected && focused && `${baseClass}--selected`]\n        .filter(Boolean)\n        .join(' ')}\n      contentEditable={false}\n      {...attributes}\n    >\n      <div className={`${baseClass}__wrap`}>\n        <p className={`${baseClass}__label`}>\n          {t('fields:labelRelationship', {\n            label: getTranslation(relatedCollection.labels.singular, i18n),\n          })}\n        </p>\n        <DocumentDrawerToggler className={`${baseClass}__doc-drawer-toggler`}>\n          <p className={`${baseClass}__title`}>\n            {data[relatedCollection?.admin?.useAsTitle || 'id']}\n          </p>\n        </DocumentDrawerToggler>\n      </div>\n      <div className={`${baseClass}__actions`}>\n        <ListDrawerToggler\n          className={`${baseClass}__list-drawer-toggler`}\n          disabled={fieldProps?.readOnly}\n        >\n          <Button\n            buttonStyle=\"icon-label\"\n            disabled={fieldProps?.readOnly}\n            el=\"div\"\n            icon=\"swap\"\n            onClick={() => {\n              // do nothing\n            }}\n            round\n            tooltip={t('fields:swapRelationship')}\n          />\n        </ListDrawerToggler>\n        <Button\n          buttonStyle=\"icon-label\"\n          className={`${baseClass}__removeButton`}\n          disabled={fieldProps?.readOnly}\n          icon=\"x\"\n          onClick={(e) => {\n            e.preventDefault()\n            removeRelationship()\n          }}\n          round\n          tooltip={t('fields:removeRelationship')}\n        />\n      </div>\n      {value?.id && <DocumentDrawer onSave={updateRelationship} />}\n      <ListDrawer onSelect={swapRelationship} />\n      {children}\n    </div>\n  )\n}\n\nexport const Element = (props: Props): React.ReactNode => {\n  return (\n    <EnabledRelationshipsCondition {...props}>\n      <RelationshipElement {...props} />\n    </EnabledRelationshipsCondition>\n  )\n}\n"],"names":["getTranslation","Button","useConfig","useDocumentDrawer","useListDrawer","usePayloadAPI","useTranslation","React","useCallback","useReducer","useState","Transforms","ReactEditor","useFocused","useSelected","useSlateStatic","useElement","EnabledRelationshipsCondition","baseClass","initialParams","depth","RelationshipElement","attributes","children","element","relationTo","value","fieldProps","collections","routes","api","serverURL","enabledCollectionSlugs","filter","admin","enableRichTextRelationship","map","slug","relatedCollection","setRelatedCollection","find","coll","selected","focused","i18n","t","editor","cacheBust","dispatchCacheBust","state","data","setParams","id","DocumentDrawer","DocumentDrawerToggler","closeDrawer","collectionSlug","ListDrawer","ListDrawerToggler","closeListDrawer","collectionSlugs","selectedCollection","removeRelationship","elementPath","findPath","removeNodes","at","updateRelationship","doc","setNodes","type","text","swapRelationship","docID","div","className","Boolean","join","contentEditable","p","label","labels","singular","useAsTitle","disabled","readOnly","buttonStyle","el","icon","onClick","round","tooltip","e","preventDefault","onSave","onSelect","Element","props"],"mappings":"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"}