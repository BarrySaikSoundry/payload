{"version":3,"sources":["../../../../../src/field/elements/link/Button/index.tsx"],"sourcesContent":["'use client'\n\nimport type { FormState } from 'payload'\n\nimport { useConfig, useDrawerSlug, useFieldProps, useModal, useTranslation } from '@payloadcms/ui'\nimport { getFormState } from '@payloadcms/ui/shared'\nimport { reduceFieldsToValues } from 'payload/shared'\nimport React, { Fragment, useState } from 'react'\nimport { Editor, Range, Transforms } from 'slate'\nimport { ReactEditor, useSlate } from 'slate-react'\n\nimport { LinkIcon } from '../../../icons/Link/index.js'\nimport { useElementButton } from '../../../providers/ElementButtonProvider.js'\nimport { ElementButton } from '../../Button.js'\nimport { isElementActive } from '../../isActive.js'\nimport { LinkDrawer } from '../LinkDrawer/index.js'\nimport { linkFieldsSchemaPath } from '../shared.js'\nimport { unwrapLink } from '../utilities.js'\n\n/**\n * This function is called when a new link is created - not when an existing link is edited.\n */\nconst insertLink = (editor, fields) => {\n  const isCollapsed = editor.selection && Range.isCollapsed(editor.selection)\n  const data = reduceFieldsToValues(fields, true)\n\n  const newLink = {\n    type: 'link',\n    children: [],\n    doc: data.doc,\n    fields: data.fields, // Any custom user-added fields are part of data.fields\n    linkType: data.linkType,\n    newTab: data.newTab,\n    url: data.url,\n  }\n\n  if (isCollapsed || !editor.selection) {\n    // If selection anchor and focus are the same,\n    // Just inject a new node with children already set\n    Transforms.insertNodes(editor, {\n      ...newLink,\n      children: [{ text: String(data.text) }],\n    })\n  } else if (editor.selection) {\n    // Otherwise we need to wrap the selected node in a link,\n    // Delete its old text,\n    // Move the selection one position forward into the link,\n    // And insert the text back into the new link\n    Transforms.wrapNodes(editor, newLink, { split: true })\n    Transforms.delete(editor, { at: editor.selection.focus.path, unit: 'word' })\n    Transforms.move(editor, { distance: 1, unit: 'offset' })\n    Transforms.insertText(editor, String(data.text), { at: editor.selection.focus.path })\n  }\n\n  ReactEditor.focus(editor)\n}\n\nexport const LinkButton: React.FC = () => {\n  const { fieldProps } = useElementButton()\n  const [initialState, setInitialState] = useState<FormState>({})\n\n  const { t } = useTranslation()\n  const editor = useSlate()\n  const config = useConfig()\n\n  const { closeModal, openModal } = useModal()\n  const drawerSlug = useDrawerSlug('rich-text-link')\n  const { schemaPath } = useFieldProps()\n\n  const { richTextComponentMap } = fieldProps\n\n  const fieldMap = richTextComponentMap.get(linkFieldsSchemaPath)\n\n  return (\n    <Fragment>\n      <ElementButton\n        className=\"link\"\n        format=\"link\"\n        onClick={async () => {\n          if (isElementActive(editor, 'link')) {\n            unwrapLink(editor)\n          } else {\n            openModal(drawerSlug)\n            const isCollapsed = editor.selection && Range.isCollapsed(editor.selection)\n            if (!isCollapsed) {\n              const data = {\n                text: editor.selection ? Editor.string(editor, editor.selection) : '',\n              }\n              const state = await getFormState({\n                apiRoute: config.routes.api,\n                body: {\n                  data,\n                  operation: 'update',\n                  schemaPath: `${schemaPath}.${linkFieldsSchemaPath}`,\n                },\n                serverURL: config.serverURL,\n              })\n              setInitialState(state)\n            }\n          }\n        }}\n        tooltip={t('fields:addLink')}\n      >\n        <LinkIcon />\n      </ElementButton>\n      <LinkDrawer\n        drawerSlug={drawerSlug}\n        fieldMap={Array.isArray(fieldMap) ? fieldMap : []}\n        handleClose={() => {\n          closeModal(drawerSlug)\n        }}\n        handleModalSubmit={(fields) => {\n          insertLink(editor, fields)\n          closeModal(drawerSlug)\n        }}\n        initialState={initialState}\n      />\n    </Fragment>\n  )\n}\n"],"names":["useConfig","useDrawerSlug","useFieldProps","useModal","useTranslation","getFormState","reduceFieldsToValues","React","Fragment","useState","Editor","Range","Transforms","ReactEditor","useSlate","LinkIcon","useElementButton","ElementButton","isElementActive","LinkDrawer","linkFieldsSchemaPath","unwrapLink","insertLink","editor","fields","isCollapsed","selection","data","newLink","type","children","doc","linkType","newTab","url","insertNodes","text","String","wrapNodes","split","delete","at","focus","path","unit","move","distance","insertText","LinkButton","fieldProps","initialState","setInitialState","t","config","closeModal","openModal","drawerSlug","schemaPath","richTextComponentMap","fieldMap","get","className","format","onClick","string","state","apiRoute","routes","api","body","operation","serverURL","tooltip","Array","isArray","handleClose","handleModalSubmit"],"mappings":"AAAA;;AAIA,SAASA,SAAS,EAAEC,aAAa,EAAEC,aAAa,EAAEC,QAAQ,EAAEC,cAAc,QAAQ,iBAAgB;AAClG,SAASC,YAAY,QAAQ,wBAAuB;AACpD,SAASC,oBAAoB,QAAQ,iBAAgB;AACrD,OAAOC,SAASC,QAAQ,EAAEC,QAAQ,QAAQ,QAAO;AACjD,SAASC,MAAM,EAAEC,KAAK,EAAEC,UAAU,QAAQ,QAAO;AACjD,SAASC,WAAW,EAAEC,QAAQ,QAAQ,cAAa;AAEnD,SAASC,QAAQ,QAAQ,+BAA8B;AACvD,SAASC,gBAAgB,QAAQ,8CAA6C;AAC9E,SAASC,aAAa,QAAQ,kBAAiB;AAC/C,SAASC,eAAe,QAAQ,oBAAmB;AACnD,SAASC,UAAU,QAAQ,yBAAwB;AACnD,SAASC,oBAAoB,QAAQ,eAAc;AACnD,SAASC,UAAU,QAAQ,kBAAiB;AAE5C;;CAEC,GACD,MAAMC,aAAa,CAACC,QAAQC;IAC1B,MAAMC,cAAcF,OAAOG,SAAS,IAAIf,MAAMc,WAAW,CAACF,OAAOG,SAAS;IAC1E,MAAMC,OAAOrB,qBAAqBkB,QAAQ;IAE1C,MAAMI,UAAU;QACdC,MAAM;QACNC,UAAU,EAAE;QACZC,KAAKJ,KAAKI,GAAG;QACbP,QAAQG,KAAKH,MAAM;QACnBQ,UAAUL,KAAKK,QAAQ;QACvBC,QAAQN,KAAKM,MAAM;QACnBC,KAAKP,KAAKO,GAAG;IACf;IAEA,IAAIT,eAAe,CAACF,OAAOG,SAAS,EAAE;QACpC,8CAA8C;QAC9C,mDAAmD;QACnDd,WAAWuB,WAAW,CAACZ,QAAQ;YAC7B,GAAGK,OAAO;YACVE,UAAU;gBAAC;oBAAEM,MAAMC,OAAOV,KAAKS,IAAI;gBAAE;aAAE;QACzC;IACF,OAAO,IAAIb,OAAOG,SAAS,EAAE;QAC3B,yDAAyD;QACzD,uBAAuB;QACvB,yDAAyD;QACzD,6CAA6C;QAC7Cd,WAAW0B,SAAS,CAACf,QAAQK,SAAS;YAAEW,OAAO;QAAK;QACpD3B,WAAW4B,MAAM,CAACjB,QAAQ;YAAEkB,IAAIlB,OAAOG,SAAS,CAACgB,KAAK,CAACC,IAAI;YAAEC,MAAM;QAAO;QAC1EhC,WAAWiC,IAAI,CAACtB,QAAQ;YAAEuB,UAAU;YAAGF,MAAM;QAAS;QACtDhC,WAAWmC,UAAU,CAACxB,QAAQc,OAAOV,KAAKS,IAAI,GAAG;YAAEK,IAAIlB,OAAOG,SAAS,CAACgB,KAAK,CAACC,IAAI;QAAC;IACrF;IAEA9B,YAAY6B,KAAK,CAACnB;AACpB;AAEA,OAAO,MAAMyB,aAAuB;IAClC,MAAM,EAAEC,UAAU,EAAE,GAAGjC;IACvB,MAAM,CAACkC,cAAcC,gBAAgB,GAAG1C,SAAoB,CAAC;IAE7D,MAAM,EAAE2C,CAAC,EAAE,GAAGhD;IACd,MAAMmB,SAAST;IACf,MAAMuC,SAASrD;IAEf,MAAM,EAAEsD,UAAU,EAAEC,SAAS,EAAE,GAAGpD;IAClC,MAAMqD,aAAavD,cAAc;IACjC,MAAM,EAAEwD,UAAU,EAAE,GAAGvD;IAEvB,MAAM,EAAEwD,oBAAoB,EAAE,GAAGT;IAEjC,MAAMU,WAAWD,qBAAqBE,GAAG,CAACxC;IAE1C,qBACE,MAACZ;;0BACC,KAACS;gBACC4C,WAAU;gBACVC,QAAO;gBACPC,SAAS;oBACP,IAAI7C,gBAAgBK,QAAQ,SAAS;wBACnCF,WAAWE;oBACb,OAAO;wBACLgC,UAAUC;wBACV,MAAM/B,cAAcF,OAAOG,SAAS,IAAIf,MAAMc,WAAW,CAACF,OAAOG,SAAS;wBAC1E,IAAI,CAACD,aAAa;4BAChB,MAAME,OAAO;gCACXS,MAAMb,OAAOG,SAAS,GAAGhB,OAAOsD,MAAM,CAACzC,QAAQA,OAAOG,SAAS,IAAI;4BACrE;4BACA,MAAMuC,QAAQ,MAAM5D,aAAa;gCAC/B6D,UAAUb,OAAOc,MAAM,CAACC,GAAG;gCAC3BC,MAAM;oCACJ1C;oCACA2C,WAAW;oCACXb,YAAY,CAAC,EAAEA,WAAW,CAAC,EAAErC,qBAAqB,CAAC;gCACrD;gCACAmD,WAAWlB,OAAOkB,SAAS;4BAC7B;4BACApB,gBAAgBc;wBAClB;oBACF;gBACF;gBACAO,SAASpB,EAAE;0BAEX,cAAA,KAACrC;;0BAEH,KAACI;gBACCqC,YAAYA;gBACZG,UAAUc,MAAMC,OAAO,CAACf,YAAYA,WAAW,EAAE;gBACjDgB,aAAa;oBACXrB,WAAWE;gBACb;gBACAoB,mBAAmB,CAACpD;oBAClBF,WAAWC,QAAQC;oBACnB8B,WAAWE;gBACb;gBACAN,cAAcA;;;;AAItB,EAAC"}