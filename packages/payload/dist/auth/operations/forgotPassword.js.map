{"version":3,"sources":["../../../src/auth/operations/forgotPassword.ts"],"sourcesContent":["import crypto from 'crypto'\nimport httpStatus from 'http-status'\nimport { URL } from 'url'\n\nimport type {\n  AuthOperationsFromCollectionSlug,\n  Collection,\n} from '../../collections/config/types.js'\nimport type { CollectionSlug } from '../../index.js'\nimport type { PayloadRequest } from '../../types/index.js'\n\nimport { buildAfterOperation } from '../../collections/operations/utils.js'\nimport { APIError } from '../../errors/index.js'\nimport { commitTransaction } from '../../utilities/commitTransaction.js'\nimport { initTransaction } from '../../utilities/initTransaction.js'\nimport { killTransaction } from '../../utilities/killTransaction.js'\n\nexport type Arguments<TSlug extends CollectionSlug> = {\n  collection: Collection\n  data: {\n    [key: string]: unknown\n  } & AuthOperationsFromCollectionSlug<TSlug>['forgotPassword']\n  disableEmail?: boolean\n  expiration?: number\n  req: PayloadRequest\n}\n\nexport type Result = string\n\nexport const forgotPasswordOperation = async <TSlug extends CollectionSlug>(\n  incomingArgs: Arguments<TSlug>,\n): Promise<null | string> => {\n  const loginWithUsername = incomingArgs.collection?.config?.auth?.loginWithUsername\n\n  if (!incomingArgs.data.email && !incomingArgs.data.username) {\n    throw new APIError(\n      `Missing ${loginWithUsername ? 'username' : 'email'}.`,\n      httpStatus.BAD_REQUEST,\n    )\n  }\n\n  let args = incomingArgs\n\n  try {\n    const shouldCommit = await initTransaction(args.req)\n\n    // /////////////////////////////////////\n    // beforeOperation - Collection\n    // /////////////////////////////////////\n\n    await args.collection.config.hooks.beforeOperation.reduce(async (priorHook, hook) => {\n      await priorHook\n\n      args =\n        (await hook({\n          args,\n          collection: args.collection?.config,\n          context: args.req.context,\n          operation: 'forgotPassword',\n          req: args.req,\n        })) || args\n    }, Promise.resolve())\n\n    const {\n      collection: { config: collectionConfig },\n      data,\n      disableEmail,\n      expiration,\n      req: {\n        payload: { config, email },\n        payload,\n      },\n      req,\n    } = args\n\n    // /////////////////////////////////////\n    // Forget password\n    // /////////////////////////////////////\n\n    let token: string = crypto.randomBytes(20).toString('hex')\n    type UserDoc = {\n      email?: string\n      id: number | string\n      resetPasswordExpiration?: string\n      resetPasswordToken?: string\n    }\n\n    if (!data.email && !data.username) {\n      throw new APIError(\n        `Missing ${loginWithUsername ? 'username' : 'email'}.`,\n        httpStatus.BAD_REQUEST,\n      )\n    }\n\n    let user = await payload.db.findOne<UserDoc>({\n      collection: collectionConfig.slug,\n      req,\n      where:\n        loginWithUsername && data?.username\n          ? { username: { equals: data.username } }\n          : { email: { equals: data.email.toLowerCase() } },\n    })\n\n    // We don't want to indicate specifically that an email was not found,\n    // as doing so could lead to the exposure of registered emails.\n    // Therefore, we prefer to fail silently.\n    if (!user) return null\n\n    user.resetPasswordToken = token\n    user.resetPasswordExpiration = new Date(expiration || Date.now() + 3600000).toISOString() // 1 hour\n\n    user = await payload.update({\n      id: user.id,\n      collection: collectionConfig.slug,\n      data: user,\n      req,\n    })\n\n    if (!disableEmail) {\n      const protocol = new URL(req.url).protocol // includes the final :\n      const serverURL =\n        config.serverURL !== null && config.serverURL !== ''\n          ? config.serverURL\n          : `${protocol}//${req.headers.get('host')}`\n\n      let html = `${req.t('authentication:youAreReceivingResetPassword')}\n    <a href=\"${serverURL}${config.routes.admin}/${config.admin.routes.reset}/${token}\">${serverURL}${config.routes.admin}/${config.admin.routes.reset}/${token}</a>\n    ${req.t('authentication:youDidNotRequestPassword')}`\n\n      if (typeof collectionConfig.auth.forgotPassword.generateEmailHTML === 'function') {\n        html = await collectionConfig.auth.forgotPassword.generateEmailHTML({\n          req,\n          token,\n          user,\n        })\n      }\n\n      let subject = req.t('authentication:resetYourPassword')\n\n      if (typeof collectionConfig.auth.forgotPassword.generateEmailSubject === 'function') {\n        subject = await collectionConfig.auth.forgotPassword.generateEmailSubject({\n          req,\n          token,\n          user,\n        })\n      }\n\n      await email.sendEmail({\n        from: `\"${email.defaultFromName}\" <${email.defaultFromAddress}>`,\n        html,\n        subject,\n        to: loginWithUsername ? user.email : data.email,\n      })\n    }\n\n    // /////////////////////////////////////\n    // afterForgotPassword - Collection\n    // /////////////////////////////////////\n\n    await collectionConfig.hooks.afterForgotPassword.reduce(async (priorHook, hook) => {\n      await priorHook\n      await hook({ args, collection: args.collection?.config, context: req.context })\n    }, Promise.resolve())\n\n    // /////////////////////////////////////\n    // afterOperation - Collection\n    // /////////////////////////////////////\n\n    token = await buildAfterOperation({\n      args,\n      collection: args.collection?.config,\n      operation: 'forgotPassword',\n      result: token,\n    })\n\n    if (shouldCommit) await commitTransaction(req)\n\n    return token\n  } catch (error: unknown) {\n    await killTransaction(args.req)\n    throw error\n  }\n}\n"],"names":["crypto","httpStatus","URL","buildAfterOperation","APIError","commitTransaction","initTransaction","killTransaction","forgotPasswordOperation","incomingArgs","loginWithUsername","collection","config","auth","data","email","username","BAD_REQUEST","args","shouldCommit","req","hooks","beforeOperation","reduce","priorHook","hook","context","operation","Promise","resolve","collectionConfig","disableEmail","expiration","payload","token","randomBytes","toString","user","db","findOne","slug","where","equals","toLowerCase","resetPasswordToken","resetPasswordExpiration","Date","now","toISOString","update","id","protocol","url","serverURL","headers","get","html","t","routes","admin","reset","forgotPassword","generateEmailHTML","subject","generateEmailSubject","sendEmail","from","defaultFromName","defaultFromAddress","to","afterForgotPassword","result","error"],"mappings":"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"}