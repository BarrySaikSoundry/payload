{"version":3,"sources":["../../../src/fields/Relationship/optionsReducer.ts"],"sourcesContent":["import { getTranslation } from '@payloadcms/translations'\n\nimport type { Action, Option, OptionGroup } from './types.js'\n\nimport { formatDocTitle } from '../../utilities/formatDocTitle.js'\n\nconst reduceToIDs = (options) =>\n  options.reduce((ids, option) => {\n    if (option.options) {\n      return [...ids, ...reduceToIDs(option.options)]\n    }\n\n    return [...ids, { id: option.value, relationTo: option.relationTo }]\n  }, [])\n\nconst sortOptions = (options: Option[]): Option[] =>\n  options.sort((a: Option, b: Option) => {\n    if (\n      typeof a?.label?.localeCompare === 'function' &&\n      typeof b?.label?.localeCompare === 'function'\n    ) {\n      return a.label.localeCompare(b.label)\n    }\n\n    return 0\n  })\n\nexport const optionsReducer = (state: OptionGroup[], action: Action): OptionGroup[] => {\n  switch (action.type) {\n    case 'CLEAR': {\n      return []\n    }\n\n    case 'UPDATE': {\n      const { collection, config, doc, i18n } = action\n      const relation = collection.slug\n      const newOptions = [...state]\n\n      const docTitle = formatDocTitle({\n        collectionConfig: collection,\n        data: doc,\n        dateFormat: config.admin.dateFormat,\n        fallback: `${i18n.t('general:untitled')} - ID: ${doc.id}`,\n        i18n,\n      })\n\n      const foundOptionGroup = newOptions.find(\n        (optionGroup) => optionGroup.label === collection.labels.plural,\n      )\n      const foundOption = foundOptionGroup?.options?.find((option) => option.value === doc.id)\n\n      if (foundOption) {\n        foundOption.label = docTitle\n        foundOption.relationTo = relation\n      }\n\n      return newOptions\n    }\n\n    case 'ADD': {\n      const { collection, config, docs, i18n, ids = [], sort } = action\n      const relation = collection.slug\n      const loadedIDs = reduceToIDs(state)\n      const newOptions = [...state]\n      const optionsToAddTo = newOptions.find(\n        (optionGroup) => optionGroup.label === collection.labels.plural,\n      )\n      const newSubOptions = docs.reduce((docSubOptions, doc) => {\n        if (\n          loadedIDs.filter((item) => item.id === doc.id && item.relationTo === relation).length ===\n          0\n        ) {\n          loadedIDs.push({ id: doc.id, relationTo: relation })\n\n          const docTitle = formatDocTitle({\n            collectionConfig: collection,\n            data: doc,\n            dateFormat: config.admin.dateFormat,\n            fallback: `${i18n.t('general:untitled')} - ID: ${doc.id}`,\n            i18n,\n          })\n\n          return [\n            ...docSubOptions,\n            {\n              label: docTitle,\n              relationTo: relation,\n              value: doc.id,\n            },\n          ]\n        }\n\n        return docSubOptions\n      }, [])\n\n      ids.forEach((id) => {\n        if (\n          loadedIDs.filter((item) => item.id === id && item.relationTo === relation).length === 0\n        ) {\n          loadedIDs.push({ id, relationTo: relation })\n          newSubOptions.push({\n            label: `${i18n.t('general:untitled')} - ID: ${id}`,\n            relationTo: relation,\n            value: id,\n          })\n        }\n      })\n\n      if (optionsToAddTo) {\n        const subOptions = [...optionsToAddTo.options, ...newSubOptions]\n\n        optionsToAddTo.options = sort ? sortOptions(subOptions) : subOptions\n      } else {\n        newOptions.push({\n          label: getTranslation(collection.labels.plural, i18n),\n          options: sort ? sortOptions(newSubOptions) : newSubOptions,\n        })\n      }\n\n      return newOptions\n    }\n\n    default: {\n      return state\n    }\n  }\n}\n"],"names":["getTranslation","formatDocTitle","reduceToIDs","options","reduce","ids","option","id","value","relationTo","sortOptions","sort","a","b","label","localeCompare","optionsReducer","state","action","type","collection","config","doc","i18n","relation","slug","newOptions","docTitle","collectionConfig","data","dateFormat","admin","fallback","t","foundOptionGroup","find","optionGroup","labels","plural","foundOption","docs","loadedIDs","optionsToAddTo","newSubOptions","docSubOptions","filter","item","length","push","forEach","subOptions"],"mappings":"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"}