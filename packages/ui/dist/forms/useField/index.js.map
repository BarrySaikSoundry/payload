{"version":3,"sources":["../../../src/forms/useField/index.tsx"],"sourcesContent":["'use client'\nimport { useCallback, useMemo, useRef } from 'react'\n\nimport type { UPDATE } from '../Form/types.js'\nimport type { FieldType, Options } from './types.js'\n\nexport type { FieldType, Options }\n\nimport { useThrottledEffect } from '../../hooks/useThrottledEffect.js'\nimport { useAuth } from '../../providers/Auth/index.js'\nimport { useConfig } from '../../providers/Config/index.js'\nimport { useDocumentInfo } from '../../providers/DocumentInfo/index.js'\nimport { useOperation } from '../../providers/Operation/index.js'\nimport { useTranslation } from '../../providers/Translation/index.js'\nimport { useFieldProps } from '../FieldPropsProvider/index.js'\nimport {\n  useForm,\n  useFormFields,\n  useFormInitializing,\n  useFormModified,\n  useFormProcessing,\n  useFormSubmitted,\n} from '../Form/context.js'\n\n/**\n * Get and set the value of a form field.\n *\n * @see https://payloadcms.com/docs/admin/hooks#usefield\n */\nexport const useField = <T,>(options: Options): FieldType<T> => {\n  const { disableFormData = false, hasRows, validate } = options\n\n  const { path: pathFromContext, permissions, readOnly, schemaPath } = useFieldProps()\n\n  // Prioritize passed in path over context path. If the context path should be prioritized (which is the case for top-level useField calls in fields), it should be passed in as the options path.\n  const path = options.path || pathFromContext\n\n  const submitted = useFormSubmitted()\n  const processing = useFormProcessing()\n  const initializing = useFormInitializing()\n  const { user } = useAuth()\n  const { id } = useDocumentInfo()\n  const operation = useOperation()\n\n  const { dispatchField, field } = useFormFields(([fields, dispatch]) => ({\n    dispatchField: dispatch,\n    field: (fields && fields?.[path]) || null,\n  }))\n\n  const { t } = useTranslation()\n  const config = useConfig()\n\n  const { getData, getDataByPath, getSiblingData, setModified } = useForm()\n  const modified = useFormModified()\n\n  const filterOptions = field?.filterOptions\n  const value = field?.value as T\n  const initialValue = field?.initialValue as T\n  const valid = typeof field?.valid === 'boolean' ? field.valid : true\n  const showError = valid === false && submitted\n\n  const prevValid = useRef(valid)\n  const prevErrorMessage = useRef(field?.errorMessage)\n\n  // Method to return from `useField`, used to\n  // update field values from field component(s)\n  const setValue = useCallback(\n    (e, disableModifyingForm = false) => {\n      const val = e && e.target ? e.target.value : e\n\n      dispatchField({\n        type: 'UPDATE',\n        disableFormData: disableFormData || (hasRows && val > 0),\n        path,\n        value: val,\n      })\n\n      if (!disableModifyingForm) {\n        if (typeof setModified === 'function') {\n          // Only update setModified to true if the form is not already set to modified. Otherwise the following could happen:\n          // 1. Text field: someone types in it in an unmodified form\n          // 2. After setTimeout triggers setModified(true): form is set to modified. Save Button becomes available. Good!\n          // 3. Type something in text field\n          // 4. Click on save button before setTimeout in useField has finished (so setModified(true) has not been run yet)\n          // 5. Form is saved, setModified(false) is set in the Form/index.tsx `submit` function, \"saved successfully\" toast appears\n          // 6. setModified(true) inside the timeout is run, form is set to modified again, even though it was already saved and thus set to unmodified. Bad! This should have happened before the form is saved. Now the form should be unmodified and stay that way\n          //    until a NEW change happens. Due to this, the \"Leave without saving\" modal appears even though it should not when leaving the page fast immediately after saving the document.\n          // This is only an issue for forms which have already been set to modified true, as that causes the save button to be enabled. If we prevent this setTimeout to be run\n          // for already-modified forms first place (which is unnecessary), we can avoid this issue. As for unmodified forms, this race issue will not happen, because you cannot click the save button faster\n          // than the timeout in useField is run. That's because the save button won't even be enabled for clicking until the setTimeout in useField has run.\n          // This fixes e2e test flakes, as e2e tests were often so fast that they were saving the form before the timeout in useField has run.\n          // Specifically, this fixes the 'should not warn about unsaved changes when navigating to lexical editor with blocks node and then leaving the page after making a change and saving' lexical e2e test.\n          if (modified === false) {\n            // Update modified state after field value comes back\n            // to avoid cursor jump caused by state value / DOM mismatch\n            setTimeout(() => {\n              setModified(true)\n            }, 10)\n          }\n        }\n      }\n    },\n    [setModified, path, dispatchField, disableFormData, hasRows, modified],\n  )\n\n  // Store result from hook as ref\n  // to prevent unnecessary rerenders\n  const result: FieldType<T> = useMemo(\n    () => ({\n      errorMessage: field?.errorMessage,\n      errorPaths: field?.errorPaths || [],\n      filterOptions,\n      formInitializing: initializing,\n      formProcessing: processing,\n      formSubmitted: submitted,\n      initialValue,\n      path,\n      permissions,\n      readOnly: readOnly || false,\n      rows: field?.rows,\n      schemaPath,\n      setValue,\n      showError,\n      valid: field?.valid,\n      value,\n    }),\n    [\n      field?.errorMessage,\n      field?.rows,\n      field?.valid,\n      field?.errorPaths,\n      processing,\n      setValue,\n      showError,\n      submitted,\n      value,\n      initialValue,\n      path,\n      schemaPath,\n      readOnly,\n      permissions,\n      filterOptions,\n      initializing,\n    ],\n  )\n\n  // Throttle the validate function\n  useThrottledEffect(\n    () => {\n      const validateField = async () => {\n        let valueToValidate = value\n\n        if (field?.rows && Array.isArray(field.rows)) {\n          valueToValidate = getDataByPath(path)\n        }\n\n        let errorMessage: string | undefined\n        let valid: boolean | string = prevValid.current\n\n        const isValid =\n          typeof validate === 'function'\n            ? await validate(valueToValidate, {\n                id,\n                config,\n                data: getData(),\n                operation,\n                siblingData: getSiblingData(path),\n                t,\n                user,\n              })\n            : true\n\n        if (typeof isValid === 'string') {\n          valid = false\n          errorMessage = isValid\n        } else if (typeof isValid === 'boolean') {\n          valid = isValid\n          errorMessage = undefined\n        }\n\n        // Only dispatch if the validation result has changed\n        // This will prevent unnecessary rerenders\n        if (valid !== prevValid.current || errorMessage !== prevErrorMessage.current) {\n          prevValid.current = valid\n          prevErrorMessage.current = errorMessage\n\n          const update: UPDATE = {\n            type: 'UPDATE',\n            errorMessage,\n            path,\n            rows: field?.rows,\n            valid,\n            // validate,\n            value,\n          }\n\n          if (disableFormData || (hasRows ? typeof value === 'number' && value > 0 : false)) {\n            update.disableFormData = true\n          }\n\n          if (typeof dispatchField === 'function') {\n            dispatchField(update)\n          }\n        }\n      }\n\n      void validateField()\n    },\n    150,\n    [\n      value,\n      disableFormData,\n      dispatchField,\n      getData,\n      getSiblingData,\n      getDataByPath,\n      id,\n      operation,\n      path,\n      user,\n      validate,\n      field?.rows,\n    ],\n  )\n\n  return result\n}\n"],"names":["useCallback","useMemo","useRef","useThrottledEffect","useAuth","useConfig","useDocumentInfo","useOperation","useTranslation","useFieldProps","useForm","useFormFields","useFormInitializing","useFormModified","useFormProcessing","useFormSubmitted","useField","options","disableFormData","hasRows","validate","path","pathFromContext","permissions","readOnly","schemaPath","submitted","processing","initializing","user","id","operation","dispatchField","field","fields","dispatch","t","config","getData","getDataByPath","getSiblingData","setModified","modified","filterOptions","value","initialValue","valid","showError","prevValid","prevErrorMessage","errorMessage","setValue","e","disableModifyingForm","val","target","type","setTimeout","result","errorPaths","formInitializing","formProcessing","formSubmitted","rows","validateField","valueToValidate","Array","isArray","current","isValid","data","siblingData","undefined","update"],"mappings":"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"}