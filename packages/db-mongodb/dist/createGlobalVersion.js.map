{"version":3,"sources":["../src/createGlobalVersion.ts"],"sourcesContent":["import type { CreateGlobalVersion, Document, PayloadRequest } from 'payload'\n\nimport type { MongooseAdapter } from './index.js'\n\nimport { withSession } from './withSession.js'\n\nexport const createGlobalVersion: CreateGlobalVersion = async function createGlobalVersion(\n  this: MongooseAdapter,\n  { autosave, createdAt, globalSlug, parent, req = {} as PayloadRequest, updatedAt, versionData },\n) {\n  const VersionModel = this.versions[globalSlug]\n  const options = await withSession(this, req)\n\n  const [doc] = await VersionModel.create(\n    [\n      {\n        autosave,\n        createdAt,\n        latest: true,\n        parent,\n        updatedAt,\n        version: versionData,\n      },\n    ],\n    options,\n    req,\n  )\n\n  await VersionModel.updateMany(\n    {\n      $and: [\n        {\n          _id: {\n            $ne: doc._id,\n          },\n        },\n        {\n          parent: {\n            $eq: parent,\n          },\n        },\n        {\n          latest: {\n            $eq: true,\n          },\n        },\n      ],\n    },\n    { $unset: { latest: 1 } },\n    options,\n  )\n\n  const result: Document = JSON.parse(JSON.stringify(doc))\n  const verificationToken = doc._verificationToken\n\n  // custom id type reset\n  result.id = result._id\n  if (verificationToken) {\n    result._verificationToken = verificationToken\n  }\n  return result\n}\n"],"names":["withSession","createGlobalVersion","autosave","createdAt","globalSlug","parent","req","updatedAt","versionData","VersionModel","versions","options","doc","create","latest","version","updateMany","$and","_id","$ne","$eq","$unset","result","JSON","parse","stringify","verificationToken","_verificationToken","id"],"mappings":"AAIA,SAASA,WAAW,QAAQ,mBAAkB;AAE9C,OAAO,MAAMC,sBAA2C,eAAeA,oBAErE,EAAEC,QAAQ,EAAEC,SAAS,EAAEC,UAAU,EAAEC,MAAM,EAAEC,MAAM,CAAC,CAAmB,EAAEC,SAAS,EAAEC,WAAW,EAAE;IAE/F,MAAMC,eAAe,IAAI,CAACC,QAAQ,CAACN,WAAW;IAC9C,MAAMO,UAAU,MAAMX,YAAY,IAAI,EAAEM;IAExC,MAAM,CAACM,IAAI,GAAG,MAAMH,aAAaI,MAAM,CACrC;QACE;YACEX;YACAC;YACAW,QAAQ;YACRT;YACAE;YACAQ,SAASP;QACX;KACD,EACDG,SACAL;IAGF,MAAMG,aAAaO,UAAU,CAC3B;QACEC,MAAM;YACJ;gBACEC,KAAK;oBACHC,KAAKP,IAAIM,GAAG;gBACd;YACF;YACA;gBACEb,QAAQ;oBACNe,KAAKf;gBACP;YACF;YACA;gBACES,QAAQ;oBACNM,KAAK;gBACP;YACF;SACD;IACH,GACA;QAAEC,QAAQ;YAAEP,QAAQ;QAAE;IAAE,GACxBH;IAGF,MAAMW,SAAmBC,KAAKC,KAAK,CAACD,KAAKE,SAAS,CAACb;IACnD,MAAMc,oBAAoBd,IAAIe,kBAAkB;IAEhD,uBAAuB;IACvBL,OAAOM,EAAE,GAAGN,OAAOJ,GAAG;IACtB,IAAIQ,mBAAmB;QACrBJ,OAAOK,kBAAkB,GAAGD;IAC9B;IACA,OAAOJ;AACT,EAAC"}