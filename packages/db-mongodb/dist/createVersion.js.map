{"version":3,"sources":["../src/createVersion.ts"],"sourcesContent":["import type { CreateVersion, Document, PayloadRequest } from 'payload'\n\nimport type { MongooseAdapter } from './index.js'\n\nimport { withSession } from './withSession.js'\n\nexport const createVersion: CreateVersion = async function createVersion(\n  this: MongooseAdapter,\n  {\n    autosave,\n    collectionSlug,\n    createdAt,\n    parent,\n    req = {} as PayloadRequest,\n    updatedAt,\n    versionData,\n  },\n) {\n  const VersionModel = this.versions[collectionSlug]\n  const options = await withSession(this, req)\n\n  const [doc] = await VersionModel.create(\n    [\n      {\n        autosave,\n        createdAt,\n        latest: true,\n        parent,\n        updatedAt,\n        version: versionData,\n      },\n    ],\n    options,\n    req,\n  )\n\n  await VersionModel.updateMany(\n    {\n      $and: [\n        {\n          _id: {\n            $ne: doc._id,\n          },\n        },\n        {\n          parent: {\n            $eq: parent,\n          },\n        },\n        {\n          latest: {\n            $eq: true,\n          },\n        },\n      ],\n    },\n    { $unset: { latest: 1 } },\n    options,\n  )\n\n  const result: Document = JSON.parse(JSON.stringify(doc))\n  const verificationToken = doc._verificationToken\n\n  // custom id type reset\n  result.id = result._id\n  if (verificationToken) {\n    result._verificationToken = verificationToken\n  }\n  return result\n}\n"],"names":["withSession","createVersion","autosave","collectionSlug","createdAt","parent","req","updatedAt","versionData","VersionModel","versions","options","doc","create","latest","version","updateMany","$and","_id","$ne","$eq","$unset","result","JSON","parse","stringify","verificationToken","_verificationToken","id"],"mappings":"AAIA,SAASA,WAAW,QAAQ,mBAAkB;AAE9C,OAAO,MAAMC,gBAA+B,eAAeA,cAEzD,EACEC,QAAQ,EACRC,cAAc,EACdC,SAAS,EACTC,MAAM,EACNC,MAAM,CAAC,CAAmB,EAC1BC,SAAS,EACTC,WAAW,EACZ;IAED,MAAMC,eAAe,IAAI,CAACC,QAAQ,CAACP,eAAe;IAClD,MAAMQ,UAAU,MAAMX,YAAY,IAAI,EAAEM;IAExC,MAAM,CAACM,IAAI,GAAG,MAAMH,aAAaI,MAAM,CACrC;QACE;YACEX;YACAE;YACAU,QAAQ;YACRT;YACAE;YACAQ,SAASP;QACX;KACD,EACDG,SACAL;IAGF,MAAMG,aAAaO,UAAU,CAC3B;QACEC,MAAM;YACJ;gBACEC,KAAK;oBACHC,KAAKP,IAAIM,GAAG;gBACd;YACF;YACA;gBACEb,QAAQ;oBACNe,KAAKf;gBACP;YACF;YACA;gBACES,QAAQ;oBACNM,KAAK;gBACP;YACF;SACD;IACH,GACA;QAAEC,QAAQ;YAAEP,QAAQ;QAAE;IAAE,GACxBH;IAGF,MAAMW,SAAmBC,KAAKC,KAAK,CAACD,KAAKE,SAAS,CAACb;IACnD,MAAMc,oBAAoBd,IAAIe,kBAAkB;IAEhD,uBAAuB;IACvBL,OAAOM,EAAE,GAAGN,OAAOJ,GAAG;IACtB,IAAIQ,mBAAmB;QACrBJ,OAAOK,kBAAkB,GAAGD;IAC9B;IACA,OAAOJ;AACT,EAAC"}