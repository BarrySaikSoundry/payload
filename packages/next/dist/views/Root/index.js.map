{"version":3,"sources":["../../../src/views/Root/index.tsx"],"sourcesContent":["import type { I18n } from '@payloadcms/translations'\nimport type { Metadata } from 'next'\nimport type { SanitizedConfig } from 'payload'\n\nimport { WithServerSideProps } from '@payloadcms/ui/shared'\nimport { notFound, redirect } from 'next/navigation.js'\nimport React, { Fragment } from 'react'\n\nimport { DefaultTemplate } from '../../templates/Default/index.js'\nimport { MinimalTemplate } from '../../templates/Minimal/index.js'\nimport { initPage } from '../../utilities/initPage/index.js'\nimport { getViewFromConfig } from './getViewFromConfig.js'\n\nexport { generatePageMetadata } from './meta.js'\n\nexport type GenerateViewMetadata = (args: {\n  config: SanitizedConfig\n  i18n: I18n\n  isEditing?: boolean\n  params?: { [key: string]: string | string[] }\n}) => Promise<Metadata>\n\nexport const RootPage = async ({\n  config: configPromise,\n  params,\n  searchParams,\n}: {\n  config: Promise<SanitizedConfig>\n  params: {\n    segments: string[]\n  }\n  searchParams: {\n    [key: string]: string | string[]\n  }\n}) => {\n  const config = await configPromise\n\n  const {\n    admin: {\n      routes: { createFirstUser: createFirstUserRoute },\n      user: userSlug,\n    },\n    routes: { admin: adminRoute },\n  } = config\n\n  const currentRoute = `${adminRoute}${Array.isArray(params.segments) ? `/${params.segments.join('/')}` : ''}`\n\n  const segments = Array.isArray(params.segments) ? params.segments : []\n\n  const { DefaultView, initPageOptions, templateClassName, templateType } = getViewFromConfig({\n    adminRoute,\n    config,\n    currentRoute,\n    searchParams,\n    segments,\n  })\n\n  let dbHasUser = false\n\n  if (!DefaultView) {\n    notFound()\n  }\n\n  const initPageResult = await initPage(initPageOptions)\n\n  if (initPageResult) {\n    dbHasUser = await initPageResult?.req.payload.db\n      .findOne({\n        collection: userSlug,\n        req: initPageResult?.req,\n      })\n      ?.then((doc) => !!doc)\n\n    const routeWithAdmin = `${adminRoute}${createFirstUserRoute}`\n\n    const collectionConfig = config.collections.find(({ slug }) => slug === userSlug)\n    const disableLocalStrategy = collectionConfig?.auth?.disableLocalStrategy\n\n    if (disableLocalStrategy && currentRoute === routeWithAdmin) {\n      redirect(adminRoute)\n    }\n\n    if (!dbHasUser && currentRoute !== routeWithAdmin && !disableLocalStrategy) {\n      redirect(routeWithAdmin)\n    }\n\n    if (dbHasUser && currentRoute === routeWithAdmin) {\n      redirect(adminRoute)\n    }\n  }\n\n  const RenderedView = (\n    <WithServerSideProps\n      Component={DefaultView}\n      serverOnlyProps={\n        {\n          initPageResult,\n          params,\n          searchParams,\n        } as any\n      }\n    />\n  )\n\n  return (\n    <Fragment>\n      {!templateType && <Fragment>{RenderedView}</Fragment>}\n      {templateType === 'minimal' && (\n        <MinimalTemplate className={templateClassName}>{RenderedView}</MinimalTemplate>\n      )}\n      {templateType === 'default' && (\n        <DefaultTemplate\n          i18n={initPageResult?.req.i18n}\n          locale={initPageResult?.locale}\n          params={params}\n          payload={initPageResult?.req.payload}\n          permissions={initPageResult?.permissions}\n          searchParams={searchParams}\n          user={initPageResult?.req.user}\n          visibleEntities={{\n            // The reason we are not passing in initPageResult.visibleEntities directly is due to a \"Cannot assign to read only property of object '#<Object>\" error introduced in React 19\n            // which this caused as soon as initPageResult.visibleEntities is passed in\n            collections: initPageResult.visibleEntities?.collections,\n            globals: initPageResult.visibleEntities?.globals,\n          }}\n        >\n          {RenderedView}\n        </DefaultTemplate>\n      )}\n    </Fragment>\n  )\n}\n"],"names":["WithServerSideProps","notFound","redirect","React","Fragment","DefaultTemplate","MinimalTemplate","initPage","getViewFromConfig","generatePageMetadata","RootPage","config","configPromise","params","searchParams","admin","routes","createFirstUser","createFirstUserRoute","user","userSlug","adminRoute","currentRoute","Array","isArray","segments","join","DefaultView","initPageOptions","templateClassName","templateType","dbHasUser","initPageResult","req","payload","db","findOne","collection","then","doc","routeWithAdmin","collectionConfig","collections","find","slug","disableLocalStrategy","auth","RenderedView","Component","serverOnlyProps","className","i18n","locale","permissions","visibleEntities","globals"],"mappings":";AAIA,SAASA,mBAAmB,QAAQ,wBAAuB;AAC3D,SAASC,QAAQ,EAAEC,QAAQ,QAAQ,qBAAoB;AACvD,OAAOC,SAASC,QAAQ,QAAQ,QAAO;AAEvC,SAASC,eAAe,QAAQ,mCAAkC;AAClE,SAASC,eAAe,QAAQ,mCAAkC;AAClE,SAASC,QAAQ,QAAQ,oCAAmC;AAC5D,SAASC,iBAAiB,QAAQ,yBAAwB;AAE1D,SAASC,oBAAoB,QAAQ,YAAW;AAShD,OAAO,MAAMC,WAAW,OAAO,EAC7BC,QAAQC,aAAa,EACrBC,MAAM,EACNC,YAAY,EASb;IACC,MAAMH,SAAS,MAAMC;IAErB,MAAM,EACJG,OAAO,EACLC,QAAQ,EAAEC,iBAAiBC,oBAAoB,EAAE,EACjDC,MAAMC,QAAQ,EACf,EACDJ,QAAQ,EAAED,OAAOM,UAAU,EAAE,EAC9B,GAAGV;IAEJ,MAAMW,eAAe,CAAC,EAAED,WAAW,EAAEE,MAAMC,OAAO,CAACX,OAAOY,QAAQ,IAAI,CAAC,CAAC,EAAEZ,OAAOY,QAAQ,CAACC,IAAI,CAAC,KAAK,CAAC,GAAG,GAAG,CAAC;IAE5G,MAAMD,WAAWF,MAAMC,OAAO,CAACX,OAAOY,QAAQ,IAAIZ,OAAOY,QAAQ,GAAG,EAAE;IAEtE,MAAM,EAAEE,WAAW,EAAEC,eAAe,EAAEC,iBAAiB,EAAEC,YAAY,EAAE,GAAGtB,kBAAkB;QAC1Fa;QACAV;QACAW;QACAR;QACAW;IACF;IAEA,IAAIM,YAAY;IAEhB,IAAI,CAACJ,aAAa;QAChB1B;IACF;IAEA,MAAM+B,iBAAiB,MAAMzB,SAASqB;IAEtC,IAAII,gBAAgB;QAClBD,YAAY,MAAMC,gBAAgBC,IAAIC,QAAQC,GAC3CC,QAAQ;YACPC,YAAYjB;YACZa,KAAKD,gBAAgBC;QACvB,IACEK,KAAK,CAACC,MAAQ,CAAC,CAACA;QAEpB,MAAMC,iBAAiB,CAAC,EAAEnB,WAAW,EAAEH,qBAAqB,CAAC;QAE7D,MAAMuB,mBAAmB9B,OAAO+B,WAAW,CAACC,IAAI,CAAC,CAAC,EAAEC,IAAI,EAAE,GAAKA,SAASxB;QACxE,MAAMyB,uBAAuBJ,kBAAkBK,MAAMD;QAErD,IAAIA,wBAAwBvB,iBAAiBkB,gBAAgB;YAC3DtC,SAASmB;QACX;QAEA,IAAI,CAACU,aAAaT,iBAAiBkB,kBAAkB,CAACK,sBAAsB;YAC1E3C,SAASsC;QACX;QAEA,IAAIT,aAAaT,iBAAiBkB,gBAAgB;YAChDtC,SAASmB;QACX;IACF;IAEA,MAAM0B,6BACJ,KAAC/C;QACCgD,WAAWrB;QACXsB,iBACE;YACEjB;YACAnB;YACAC;QACF;;IAKN,qBACE,MAACV;;YACE,CAAC0B,8BAAgB,KAAC1B;0BAAU2C;;YAC5BjB,iBAAiB,2BAChB,KAACxB;gBAAgB4C,WAAWrB;0BAAoBkB;;YAEjDjB,iBAAiB,2BAChB,KAACzB;gBACC8C,MAAMnB,gBAAgBC,IAAIkB;gBAC1BC,QAAQpB,gBAAgBoB;gBACxBvC,QAAQA;gBACRqB,SAASF,gBAAgBC,IAAIC;gBAC7BmB,aAAarB,gBAAgBqB;gBAC7BvC,cAAcA;gBACdK,MAAMa,gBAAgBC,IAAId;gBAC1BmC,iBAAiB;oBACf,+KAA+K;oBAC/K,2EAA2E;oBAC3EZ,aAAaV,eAAesB,eAAe,EAAEZ;oBAC7Ca,SAASvB,eAAesB,eAAe,EAAEC;gBAC3C;0BAECR;;;;AAKX,EAAC"}