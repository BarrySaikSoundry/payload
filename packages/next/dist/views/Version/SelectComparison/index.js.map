{"version":3,"sources":["../../../../src/views/Version/SelectComparison/index.tsx"],"sourcesContent":["'use client'\n\nimport type { PaginatedDocs, Where } from 'payload'\n\nimport { ReactSelect, fieldBaseClass, useConfig, useTranslation } from '@payloadcms/ui'\nimport { formatDate } from '@payloadcms/ui/shared'\nimport * as qs from 'qs-esm'\nimport React, { useCallback, useEffect, useState } from 'react'\n\nimport type { Props } from './types.js'\n\nimport { renderPill } from '../../Versions/cells/AutosaveCell/index.js'\nimport './index.scss'\n\nconst baseClass = 'compare-version'\n\nconst maxResultsPerRequest = 10\n\nconst baseOptions = []\n\nexport const SelectComparison: React.FC<Props> = (props) => {\n  const {\n    baseURL,\n    latestDraftVersion,\n    latestPublishedVersion,\n    onChange,\n    parentID,\n    value,\n    versionID,\n  } = props\n\n  const {\n    admin: { dateFormat },\n  } = useConfig()\n\n  const [options, setOptions] = useState<\n    {\n      label: React.ReactNode | string\n      value: string\n    }[]\n  >(baseOptions)\n  const [lastLoadedPage, setLastLoadedPage] = useState(1)\n  const [errorLoading, setErrorLoading] = useState('')\n  const { i18n, t } = useTranslation()\n  const loadedAllOptionsRef = React.useRef(false)\n\n  const getResults = useCallback(\n    async ({ lastLoadedPage: lastLoadedPageArg }) => {\n      if (loadedAllOptionsRef.current) return\n      const query: {\n        [key: string]: unknown\n        where: Where\n      } = {\n        depth: 0,\n        limit: maxResultsPerRequest,\n        page: lastLoadedPageArg,\n        where: {\n          and: [\n            {\n              id: {\n                not_equals: versionID,\n              },\n            },\n          ],\n        },\n      }\n\n      if (parentID) {\n        query.where.and.push({\n          parent: {\n            equals: parentID,\n          },\n        })\n      }\n\n      const search = qs.stringify(query)\n\n      const response = await fetch(`${baseURL}?${search}`, {\n        credentials: 'include',\n        headers: {\n          'Accept-Language': i18n.language,\n        },\n      })\n\n      if (response.ok) {\n        const data: PaginatedDocs = await response.json()\n\n        if (data.docs.length > 0) {\n          const versionInfo = {\n            draft: {\n              currentLabel: t('version:currentDraft'),\n              latestVersion: latestDraftVersion,\n              pillStyle: undefined,\n              previousLabel: t('version:draft'),\n            },\n            published: {\n              currentLabel: t('version:currentPublishedVersion'),\n              latestVersion: latestPublishedVersion,\n              pillStyle: 'success',\n              previousLabel: t('version:previouslyPublished'),\n            },\n          }\n\n          const additionalOptions = data.docs.map((doc) => {\n            const status = doc.version._status\n            const { currentLabel, latestVersion, pillStyle, previousLabel } =\n              versionInfo[status] || {}\n\n            return {\n              label: (\n                <div>\n                  {formatDate({ date: doc.updatedAt, i18n, pattern: dateFormat })}\n                  &nbsp;&nbsp;\n                  {renderPill(doc, latestVersion, currentLabel, previousLabel, pillStyle)}\n                </div>\n              ),\n              value: doc.id,\n            }\n          })\n\n          setOptions((existingOptions) => [...existingOptions, ...additionalOptions])\n\n          if (!data.hasNextPage) {\n            loadedAllOptionsRef.current = true\n          }\n          setLastLoadedPage(data.page)\n        }\n      } else {\n        setErrorLoading(t('error:unspecific'))\n      }\n    },\n    [dateFormat, baseURL, parentID, versionID, t, i18n, latestDraftVersion, latestPublishedVersion],\n  )\n\n  useEffect(() => {\n    void getResults({ lastLoadedPage: 1 })\n  }, [getResults])\n\n  const filteredOptions = options.filter(\n    (option, index, self) => self.findIndex((t) => t.value === option.value) === index,\n  )\n\n  useEffect(() => {\n    if (filteredOptions.length > 0 && !value) {\n      onChange(filteredOptions[0])\n    }\n  }, [filteredOptions, value, onChange])\n\n  return (\n    <div\n      className={[fieldBaseClass, baseClass, errorLoading && 'error-loading']\n        .filter(Boolean)\n        .join(' ')}\n    >\n      <div className={`${baseClass}__label`}>{t('version:compareVersion')}</div>\n      {!errorLoading && (\n        <ReactSelect\n          isClearable={false}\n          isSearchable={false}\n          onChange={onChange}\n          onMenuScrollToBottom={() => {\n            void getResults({ lastLoadedPage: lastLoadedPage + 1 })\n          }}\n          options={filteredOptions}\n          placeholder={t('version:selectVersionToCompare')}\n          value={value}\n        />\n      )}\n      {errorLoading && <div className={`${baseClass}__error-loading`}>{errorLoading}</div>}\n    </div>\n  )\n}\n"],"names":["ReactSelect","fieldBaseClass","useConfig","useTranslation","formatDate","qs","React","useCallback","useEffect","useState","renderPill","baseClass","maxResultsPerRequest","baseOptions","SelectComparison","props","baseURL","latestDraftVersion","latestPublishedVersion","onChange","parentID","value","versionID","admin","dateFormat","options","setOptions","lastLoadedPage","setLastLoadedPage","errorLoading","setErrorLoading","i18n","t","loadedAllOptionsRef","useRef","getResults","lastLoadedPageArg","current","query","depth","limit","page","where","and","id","not_equals","push","parent","equals","search","stringify","response","fetch","credentials","headers","language","ok","data","json","docs","length","versionInfo","draft","currentLabel","latestVersion","pillStyle","undefined","previousLabel","published","additionalOptions","map","doc","status","version","_status","label","div","date","updatedAt","pattern","existingOptions","hasNextPage","filteredOptions","filter","option","index","self","findIndex","className","Boolean","join","isClearable","isSearchable","onMenuScrollToBottom","placeholder"],"mappings":"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"}