{"version":3,"sources":["../../../../src/routes/rest/globals/preview.ts"],"sourcesContent":["import httpStatus from 'http-status'\nimport { extractJWT, findOneOperation } from 'payload'\nimport { isNumber } from 'payload/shared'\n\nimport type { GlobalRouteHandler } from '../types.js'\n\nimport { headersWithCors } from '../../../utilities/headersWithCors.js'\nimport { routeError } from '../routeError.js'\n\nexport const preview: GlobalRouteHandler = async ({ globalConfig, req }) => {\n  const { searchParams } = req\n  const depth = searchParams.get('depth')\n\n  const result = await findOneOperation({\n    slug: globalConfig.slug,\n    depth: isNumber(depth) ? Number(depth) : undefined,\n    draft: searchParams.get('draft') === 'true',\n    globalConfig,\n    req,\n  })\n\n  let previewURL: string\n\n  const generatePreviewURL = req.payload.config.globals.find(\n    (config) => config.slug === globalConfig.slug,\n  )?.admin?.preview\n\n  const token = extractJWT(req)\n\n  if (typeof generatePreviewURL === 'function') {\n    try {\n      previewURL = await generatePreviewURL(result, {\n        locale: req.locale,\n        req,\n        token,\n      })\n    } catch (err) {\n      return routeError({\n        config: req.payload.config,\n        err,\n        req,\n      })\n    }\n  }\n\n  return Response.json(previewURL, {\n    headers: headersWithCors({\n      headers: new Headers(),\n      req,\n    }),\n    status: httpStatus.OK,\n  })\n}\n"],"names":["httpStatus","extractJWT","findOneOperation","isNumber","headersWithCors","routeError","preview","globalConfig","req","searchParams","depth","get","result","slug","Number","undefined","draft","previewURL","generatePreviewURL","payload","config","globals","find","admin","token","locale","err","Response","json","headers","Headers","status","OK"],"mappings":"AAAA,OAAOA,gBAAgB,cAAa;AACpC,SAASC,UAAU,EAAEC,gBAAgB,QAAQ,UAAS;AACtD,SAASC,QAAQ,QAAQ,iBAAgB;AAIzC,SAASC,eAAe,QAAQ,wCAAuC;AACvE,SAASC,UAAU,QAAQ,mBAAkB;AAE7C,OAAO,MAAMC,UAA8B,OAAO,EAAEC,YAAY,EAAEC,GAAG,EAAE;IACrE,MAAM,EAAEC,YAAY,EAAE,GAAGD;IACzB,MAAME,QAAQD,aAAaE,GAAG,CAAC;IAE/B,MAAMC,SAAS,MAAMV,iBAAiB;QACpCW,MAAMN,aAAaM,IAAI;QACvBH,OAAOP,SAASO,SAASI,OAAOJ,SAASK;QACzCC,OAAOP,aAAaE,GAAG,CAAC,aAAa;QACrCJ;QACAC;IACF;IAEA,IAAIS;IAEJ,MAAMC,qBAAqBV,IAAIW,OAAO,CAACC,MAAM,CAACC,OAAO,CAACC,IAAI,CACxD,CAACF,SAAWA,OAAOP,IAAI,KAAKN,aAAaM,IAAI,GAC5CU,OAAOjB;IAEV,MAAMkB,QAAQvB,WAAWO;IAEzB,IAAI,OAAOU,uBAAuB,YAAY;QAC5C,IAAI;YACFD,aAAa,MAAMC,mBAAmBN,QAAQ;gBAC5Ca,QAAQjB,IAAIiB,MAAM;gBAClBjB;gBACAgB;YACF;QACF,EAAE,OAAOE,KAAK;YACZ,OAAOrB,WAAW;gBAChBe,QAAQZ,IAAIW,OAAO,CAACC,MAAM;gBAC1BM;gBACAlB;YACF;QACF;IACF;IAEA,OAAOmB,SAASC,IAAI,CAACX,YAAY;QAC/BY,SAASzB,gBAAgB;YACvByB,SAAS,IAAIC;YACbtB;QACF;QACAuB,QAAQ/B,WAAWgC,EAAE;IACvB;AACF,EAAC"}